# Integrating Diagram Schema Generation into Codegen Pipeline

## Current State {#current-state}

**Node Schemas (auto-generated):**
- Location: `dipeo/diagram_generated/schemas/nodes/*.schema.json`
- Generated from TypeScript specs during `make codegen`
- Used for runtime validation

**Diagram Schema (manual):**
- Location: `dipeo/diagram_generated/schemas/dipeo-light.schema.json`
- Generated by `scripts/generate_light_diagram_schema.py`
- Used for IDE autocomplete/validation
- **Problem**: Hardcoded node definitions, can drift from TypeScript specs

## Integration Plan {#integration-plan}

### Phase 1: Use Generated Node Schemas ✅ {#phase-1-use-generated-node-schemas}

**Revise `scripts/generate_light_diagram_schema.py` to:**
1. Read generated node schemas from `dipeo/diagram_generated/schemas/nodes/`
2. Extract node type definitions from these schemas
3. Build the main diagram schema by assembling node schemas
4. Remove hardcoded node type definitions

**Benefits:**
- Single source of truth (TypeScript → node schemas → diagram schema)
- No drift between node schemas and diagram schema
- Automatic updates when node types change

### Phase 2: Integrate into Codegen Pipeline {#phase-2-integrate-into-codegen-pipeline}

**Add diagram schema generation step to codegen workflow:**

1. **Update codegen diagram** (`projects/codegen/diagrams/generate_backend_simplified.light.yaml`):
   ```yaml
   # Add new node after other backend generation steps
   - label: Generate Diagram Schema
     type: code_job
     position: {x: 900, y: 200}
     props:
       language: python
       code: |
         import subprocess
         result = subprocess.run(
             ["python", "scripts/generate_light_diagram_schema.py"],
             capture_output=True,
             text=True
         )
         print(result.stdout)
         if result.returncode != 0:
             raise Exception(f"Schema generation failed: {result.stderr}")
   ```

2. **Update script output path**:
   - Change output from `dipeo/diagram_generated/schemas/`
   - To: `dipeo/diagram_generated_staged/schemas/`
   - This makes it part of the staged/apply workflow

3. **Update Makefile** (optional):
   ```makefile
   # Add convenience target
   diagram-schema:
   	@echo "Generating diagram schema from node schemas..."
   	@python scripts/generate_light_diagram_schema.py
   	@echo "✓ Diagram schema generated"
   ```

4. **Connect in workflow**:
   ```yaml
   connections:
     # Generate node schemas first
     - {from: Generate Backend Models, to: Generate Node Schemas}
     # Then generate diagram schema using node schemas
     - {from: Generate Node Schemas, to: Generate Diagram Schema}
   ```

### Phase 3: Validation & Testing {#phase-3-validation-testing}

**Add validation step:**
1. Verify all node types from TypeScript specs are included
2. Check that required fields match node schema definitions
3. Validate generated schema against JSON Schema meta-schema

**Testing:**
```bash
# Test the flow
make codegen
make diff-staged  # Should show updated diagram schema
make apply-test   # Apply changes

# Verify IDE integration works
# Open .light.yaml file, should get autocomplete
```

## Implementation Order {#implementation-order}

1. ✅ **Revise script** to use generated node schemas (remove hardcoding)
2. **Test standalone** script works with generated schemas
3. **Add to codegen diagram** as a code_job node
4. **Update output path** to diagram_generated_staged
5. **Test full flow** with `make codegen`
6. **Update CLAUDE.md** to document the integration

## Benefits {#benefits}

- **Automatic sync**: Diagram schema auto-updates when node types change
- **Staged workflow**: Schema changes reviewed via `make diff-staged`
- **Single source of truth**: TypeScript specs → everything else
- **No manual maintenance**: Schema generation is part of normal codegen flow

## Files to Modify {#files-to-modify}

1. `scripts/generate_light_diagram_schema.py` - Use generated schemas
2. `projects/codegen/diagrams/generate_backend_simplified.light.yaml` - Add generation step
3. `CLAUDE.md` - Update documentation (remove manual script mention)
4. Optional: `Makefile` - Add convenience target
