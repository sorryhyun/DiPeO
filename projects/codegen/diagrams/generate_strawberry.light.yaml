version: light
# Unified Strawberry Code Generation Pipeline
# This diagram consolidates all strawberry generation into a single IR-based flow
# using template_job nodes for rendering

nodes:
  - label: Start
    type: start
    position: {x: 50, y: 400}
    props:
      custom_data:
        message: Starting unified strawberry generation

  # Load all TypeScript AST files
  - label: Load TypeScript AST
    type: db
    position: {x: 200, y: 400}
    props:
      operation: read
      sub_type: file
      format: json
      glob: true
      file:
        - "temp/**/*.ts.json"
        - "temp/frontend/query-definitions/*.ts.json"
        - "temp/core/enums/*.ts.json"  # Explicitly include core enums

  # Build unified IR from TypeScript AST
  - label: Build Unified IR
    type: code_job
    position: {x: 400, y: 400}
    props:
      language: python
      filePath: projects/codegen/code/strawberry_ir_builder.py
      functionName: build_unified_ir

  # Render all templates using template_job nodes
  # Note: Templates will receive the IR data from the Build Unified IR node
  - label: Render Strawberry Types
    type: template_job
    position: {x: 600, y: 200}
    props:
      engine: jinja2
      template_path: projects/codegen/templates/strawberry/strawberry_types.j2
      output_path: dipeo/diagram_generated_staged/graphql/strawberry_nodes.py
      variables:
        module_name: "strawberry_nodes"
        generated_warning: "DO NOT EDIT - Generated by DiPeO Unified Strawberry Pipeline"
      # The IR data comes through the connection and will be available in the template

  - label: Render Scalars
    type: template_job
    position: {x: 600, y: 300}
    props:
      engine: jinja2
      template_path: projects/codegen/templates/strawberry/strawberry_scalars.j2
      output_path: dipeo/diagram_generated_staged/graphql/scalars.py
      variables:
        module_name: "scalars"
        generated_warning: "DO NOT EDIT - Generated by DiPeO Unified Strawberry Pipeline"

  - label: Render Domain Types
    type: template_job
    position: {x: 600, y: 400}
    props:
      engine: jinja2
      template_path: projects/codegen/templates/strawberry/strawberry_domain_full.j2
      output_path: dipeo/diagram_generated_staged/graphql/domain_types.py
      variables:
        module_name: "domain_types"
        generated_warning: "DO NOT EDIT - Generated by DiPeO Unified Strawberry Pipeline"

  - label: Render Input Types
    type: template_job
    position: {x: 600, y: 500}
    props:
      engine: jinja2
      template_path: projects/codegen/templates/strawberry/strawberry_inputs.j2
      output_path: dipeo/diagram_generated_staged/graphql/inputs.py
      variables:
        module_name: "inputs"
        generated_warning: "DO NOT EDIT - Generated by DiPeO Unified Strawberry Pipeline"

  - label: Render GraphQL Enums
    type: template_job
    position: {x: 600, y: 600}
    props:
      engine: jinja2
      template_path: projects/codegen/templates/strawberry/strawberry_enums.j2
      output_path: dipeo/diagram_generated_staged/graphql/enums.py
      variables:
        module_name: "enums"
        generated_warning: "DO NOT EDIT - Generated by DiPeO Unified Strawberry Pipeline"

  - label: Render Mutations
    type: template_job
    position: {x: 800, y: 400}
    props:
      engine: jinja2
      template_path: projects/codegen/templates/strawberry/strawberry_mutations.j2
      output_path: dipeo/diagram_generated_staged/graphql/node_mutations.py
      variables:
        module_name: "node_mutations"
        generated_warning: "DO NOT EDIT - Generated by DiPeO Unified Strawberry Pipeline"

  # Operations-related template nodes
  - label: Render Operations
    type: template_job
    position: {x: 600, y: 700}
    props:
      engine: jinja2
      template_path: projects/codegen/templates/strawberry/python-graphql-operations.j2
      output_path: dipeo/diagram_generated_staged/graphql/operations.py
      variables:
        module_name: "operations"
        generated_warning: "DO NOT EDIT - Generated by DiPeO Unified Strawberry Pipeline"

  - label: Render Results
    type: template_job
    position: {x: 600, y: 800}
    props:
      engine: jinja2
      template_path: projects/codegen/templates/strawberry/strawberry_results.j2
      output_path: dipeo/diagram_generated_staged/graphql/results.py
      variables:
        module_name: "results"
        generated_warning: "DO NOT EDIT - Generated by DiPeO Unified Strawberry Pipeline"

  - label: Render Generated Schema
    type: template_job
    position: {x: 800, y: 700}
    props:
      engine: jinja2
      template_path: projects/codegen/templates/strawberry/strawberry_schema_from_operations.j2
      output_path: dipeo/diagram_generated_staged/graphql/generated_schema.py
      variables:
        module_name: "generated_schema"
        generated_warning: "DO NOT EDIT - Generated by DiPeO Unified Strawberry Pipeline"

  # End node
  - label: End
    type: endpoint
    position: {x: 1000, y: 400}
    props:
      custom_data:
        message: Strawberry generation complete

connections:
  # Sequential flow: Load AST -> Build Unified IR
  - {from: Start, to: Load TypeScript AST}
  - {from: Load TypeScript AST, to: Build Unified IR, content_type: object}

  # Parallel template rendering from unified IR
  - {from: Build Unified IR, to: Render Strawberry Types}
  - {from: Build Unified IR, to: Render Scalars}
  - {from: Build Unified IR, to: Render Domain Types}
  - {from: Build Unified IR, to: Render Input Types}
  - {from: Build Unified IR, to: Render GraphQL Enums}
  - {from: Build Unified IR, to: Render Mutations}
  - {from: Build Unified IR, to: Render Operations}
  - {from: Build Unified IR, to: Render Results}
  - {from: Build Unified IR, to: Render Generated Schema}

  # Complete
  - {from: Render Strawberry Types, to: End}
  - {from: Render Scalars, to: End}
  - {from: Render Domain Types, to: End}
  - {from: Render Input Types, to: End}
  - {from: Render GraphQL Enums, to: End}
  - {from: Render Mutations, to: End}
  - {from: Render Operations, to: End}
  - {from: Render Results, to: End}
  - {from: Render Generated Schema, to: End}
