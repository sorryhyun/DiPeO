# Generate Python Domain Models V3 - Simplified
# Uses simplified extractor that works directly with DB glob results
# Dynamically discovers TypeScript files using glob patterns

version: light

nodes:
  - label: Start
    type: start
    position: {x: 50, y: 300}
    props:
      custom_data:
        message: Starting Python domain model generation V3 with dynamic file discovery

  # Run batch parser if cache doesn't exist
  - label: Parse TypeScript Batch
    type: sub_diagram
    position: {x: 200, y: 300}
    props:
      diagram_name: projects/codegen/diagrams/shared/parse_typescript_batch_direct
      diagram_format: light
      passInputData: false
      ignoreIfSub: true

  # NEW: Load all AST files dynamically using glob patterns
  - label: Load All AST Files
    type: db
    position: {x: 400, y: 300}
    props:
      operation: read
      sub_type: file
      glob: true  # Enable glob pattern expansion
      format: json
      source_details:
        # Core domain model files
        - temp/core/diagram.ts.json
        - temp/core/execution.ts.json
        - temp/core/conversation.ts.json
        - temp/utilities/diagram-utils.ts.json
        - temp/core/integration.ts.json
        # Base node data interface (must be loaded before node data files)
        - temp/core/nodes/base.ts.json
        # Dynamic discovery of all node data files
        - "temp/core/nodes/*.data.ts.json"

  # Extract raw model data using simplified extractor
  - label: Extract Raw Model Data
    type: code_job
    position: {x: 600, y: 300}
    props:
      language: python
      filePath: projects/codegen/code/shared/simplified_extractors.py
      functionName: extract_models_from_glob

  # Use template_job with enhanced template for rendering
  - label: Render Python Models Enhanced
    type: template_job
    position: {x: 800, y: 300}
    props:
      engine: jinja2  # Will use enhanced service with TypeScript filters
      template_path: projects/codegen/templates/models/python_models.j2
      output_path: dipeo/diagram_generated_staged/domain_models.py
      variables:
        module_name: "domain_models"
        generated_warning: "DO NOT EDIT - Generated by DiPeO V3 Dynamic"

  # Generate success summary
  - label: Generate Summary
    type: code_job
    position: {x: 1000, y: 300}
    props:
      language: python
      filePath: projects/codegen/code/models/python_models_extractor_v2.py
      functionName: generate_summary

  - label: End
    type: endpoint
    position: {x: 1200, y: 300}
    props:
      save_to_file: false

connections:
  # Run batch parser first
  - {from: Start, to: Parse TypeScript Batch}
  
  # Load cached AST data after parsing
  - {from: Parse TypeScript Batch, to: Load All AST Files}
  
  # Pass glob results directly to simplified extractor
  - {from: Load All AST Files, to: Extract Raw Model Data, label: default, content_type: object}
  
  # Pass raw extracted data to template renderer
  - {from: Extract Raw Model Data, to: Render Python Models Enhanced, label: model_data, content_type: object}  # Raw TypeScript data for template to process
  
  # Generate summary with counts from extraction
  - {from: Extract Raw Model Data, to: Generate Summary, label: generation_result}
  
  - {from: Render Python Models Enhanced, to: End}
  - {from: Generate Summary, to: End}