"""Handler for {{ display_name }} - {{ description }}

This handler stub was automatically generated from the TypeScript node specification.
TODO: Implement the business logic for this node type.
"""

import logging
from typing import TYPE_CHECKING, Any, Optional

from dipeo.application.execution.handlers.core.factory import register_handler
from dipeo.application.execution.handlers.core.base import TypedNodeHandler
from dipeo.application.execution.execution_request import ExecutionRequest
from dipeo.diagram_generated.generated_nodes import NodeType
from dipeo.diagram_generated.unified_nodes.{{ node_type }}_node import {{ data_model_name }}
from dipeo.domain.execution.envelope import Envelope, EnvelopeFactory
{% if handler_metadata and handler_metadata.get('mixins') %}
{% for mixin in handler_metadata['mixins'] %}
from dipeo.application.execution.handlers.core.mixins import {{ mixin }}
{% endfor %}
{% endif %}
{% if handler_metadata and handler_metadata.get('customImports') %}
{% for import in handler_metadata['customImports'] %}
{{ import }}
{% endfor %}
{% endif %}

if TYPE_CHECKING:
    pass

logger = logging.getLogger(__name__)


@register_handler
class {{ handler_class_name }}({% if handler_metadata and handler_metadata.get('mixins') %}{% for mixin in handler_metadata['mixins'] %}{{ mixin }}, {% endfor %}{% endif %}TypedNodeHandler[{{ data_model_name }}]):
    """Handler for {{ display_name }} node.

    {{ description }}

    Category: {{ category }}
    {% if handler_metadata and handler_metadata.get('serviceKeys') %}
    Required Services: {{ handler_metadata['serviceKeys'] | join(', ') }}
    {% endif %}
    {% if handler_metadata and handler_metadata.get('mixins') %}
    Mixins: {{ handler_metadata['mixins'] | join(', ') }}
    {% endif %}
    {% if timeout %}
    Timeout: {{ timeout }}ms
    {% endif %}
    """

    @property
    def node_type(self) -> str:
        """Return the node type this handler manages."""
        return NodeType.{{ node_type_upper }}

    @property
    def schema(self):
        """Return the Pydantic model for node data validation."""
        return {{ data_model_name }}

    @property
    def requires_services(self) -> list[str]:
        """Return list of required services for this handler."""
        {% if handler_metadata and handler_metadata.get('serviceKeys') %}
        return {{ handler_metadata['serviceKeys'] }}
        {% else %}
        return []
        {% endif %}

    async def execute_request(self, request: ExecutionRequest) -> Any:
        """Execute the {{ display_name }} node logic.

        Args:
            request: Execution request containing node data and context

        Returns:
            Execution result wrapped in appropriate envelope
        """
        # Access validated node data
        node_data = request.node.data  # Type: {{ data_model_name }}

        # Access resolved inputs
        inputs = request.resolved_inputs

        # TODO: Implement {{ display_name }} business logic
        # Example structure:
        # 1. Validate any runtime requirements
        # 2. Process inputs based on node configuration
        # 3. Perform the main operation for this node type
        # 4. Return results wrapped in appropriate envelope

        # Example of accessing node data fields:
        # if node_data.some_field:
        #     result = await self.process_field(node_data.some_field)

        # Example of using services (if configured):
        {% if handler_metadata and handler_metadata.get('serviceKeys') %}
        {% if 'LLM_CLIENT' in handler_metadata.get('serviceKeys', []) %}
        # llm_client = self.services.get('LLM_CLIENT')
        # if llm_client:
        #     response = await llm_client.complete(prompt)
        {% endif %}
        {% if 'STATE_STORE' in handler_metadata.get('serviceKeys', []) %}
        # state_store = self.services.get('STATE_STORE')
        # if state_store:
        #     state = await state_store.get_state(request.execution_id)
        {% endif %}
        {% if 'HTTP_CLIENT' in handler_metadata.get('serviceKeys', []) %}
        # http_client = self.services.get('HTTP_CLIENT')
        # if http_client:
        #     response = await http_client.request(method, url, **kwargs)
        {% endif %}
        {% if 'EVENT_BUS' in handler_metadata.get('serviceKeys', []) %}
        # event_bus = self.services.get('EVENT_BUS')
        # if event_bus:
        #     await event_bus.emit(event_name, event_data)
        {% endif %}
        {% endif %}

        # Example of creating output envelope:
        # result = {
        #     'status': 'success',
        #     'data': processed_data
        # }
        # return EnvelopeFactory.create_single(result)

        raise NotImplementedError(
            f"Handler for {{ display_name }} ({{ node_type }}) not yet implemented. "
            f"Please implement the business logic in this execute_request method."
        )
