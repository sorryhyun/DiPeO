version: light

persons:
  Section Planner:
    service: openai
    model: gpt-5-mini-2025-08-07
    api_key_id: APIKEY_52609F
    system_prompt: |
      You are a senior product/front-end architect with expertise in React, TypeScript, and modern web architecture.
      
      Your task is to:
      1. Define the overall architecture and folder structure
      2. Split work into sections where EACH section represents ONE specific file
      3. List all files that need to be implemented with clear descriptions
      
      Focus on:
      - COMPLETENESS: Include every file that will be imported anywhere
      - Clear file paths and responsibilities
      - Logical grouping and dependencies between files
      - Modern React 18+ and TypeScript patterns
      
      Note: You don't need to provide detailed implementation steps. The Core Kernel will handle shared contracts, and the Frontend Generator will handle implementation details.

  Core Kernel Architect:
    service: openai
    model: gpt-5-mini-2025-08-07
    api_key_id: APIKEY_52609F
    system_prompt: |
      You are an expert TypeScript architect specializing in creating foundational contracts and utilities.
      
      Your task is to generate the Core Kernel - a set of 5-7 foundational files that ALL sections will depend on.
      These files establish the single source of truth for types, configuration, events, hooks, and utilities.
      
      Generate complete, production-ready TypeScript code with:
      - Comprehensive domain types and API contracts
      - Materialized configuration from the app config
      - Event bus for decoupled communication
      - Hook system for extension points
      - Dependency injection tokens
      
      Every file must be immediately usable with no placeholders or TODOs.

  Frontend Generator:
#    service: openai
#    model: gpt-5-nano-2025-08-07
#    api_key_id: APIKEY_52609F
    service: claude-code
    model: claude-code
    api_key_id: APIKEY_CLAUDE
    system_prompt: |
      You are an expert React/TypeScript engineer. Your task is to generate production-ready code following the detailed instructions in the prompt file.
      
      KEY FOCUS:
      - Generate ONLY raw code without any explanations or commentary
      - Follow ALL conventions and contracts defined in the prompt
      - Build iteratively using context from previous sections
      - Code must be complete, working, and deployable as-is

nodes:
  - label: Start
    type: start
    position: {x: 60, y: 240}
    props:
      trigger_mode: manual
      
  - label: Load Config
    type: db
    position: {x: 300, y: 240}
    props:
      operation: read
      sub_type: file
      format: json
      source_details: projects/frontend_auto/variants/healthcare_portal_config.json

  - label: Plan Sections
    type: person_job
    position: {x: 400, y: 240}
    props:
      person: Section Planner
      text_format_file: projects/frontend_auto/section_models.py
      default_prompt: |
        Analyze the requirements and create a file structure plan:

        App config: {{config}}

        Your response MUST include:
        1. Architecture:
           - High-level overview of the application structure
           - Key patterns and technologies to use
           - Folder structure showing organization
           - Data flow description

        2. Sections (one per file):
           - id: unique identifier
           - file_to_implement: exact file path
           - description: what the file does
           - dependencies: other files it imports from
           - exports: what it provides to other files
           - priority: 1=foundational, 2=components, 3=pages

        REQUIREMENTS:
        - Order sections by priority and dependencies
        - Include ALL files that will exist in the app
        - Every import must have a corresponding section
        - Cover: pages, providers, services, shared components, hooks, features

        Note: Core Kernel will handle shared types and contracts - just list the files needed.

  - label: Save Sections Data
    type: db
    position: {x: 800, y: 240}
    props:
      operation: write
      sub_type: file
      format: json
      source_details: projects/frontend_auto/generated/sections_data.json

  - label: Generate Core Kernel
    type: person_job
    position: {x: 950, y: 240}
    props:
      person: Core Kernel Architect
      text_format_file: projects/frontend_auto/core_kernel_models.py
      prompt_file: core_kernel_generator.txt

  - label: Write Kernel Files
    type: code_job
    position: {x: 1100, y: 240}
    props:
      language: python
      filePath: projects/frontend_auto/write_kernel_files.py
      functionName: write_kernel_files

  - label: Load Sections Data
    type: db
    position: {x: 1250, y: 240}
    props:
      operation: read
      sub_type: file
      format: json
      source_details: projects/frontend_auto/generated/sections_data.json

  - label: Load Core Kernel
    type: db
    position: {x: 1400, y: 240}
    props:
      operation: read
      sub_type: file
      format: json
      source_details: projects/frontend_auto/generated/core_kernel_data.json

  - label: Check Continue
    type: condition
    position: {x: 1650, y: 240}
    props:
      condition_type: custom
      expression: current_index >= 4
#      expression: current_index >= len(default.file_paths)
      expose_index_as: current_index
      flipped: [false, true]

  - label: Load Sections Data again
    type: db
    position: {x: 1650, y: 400}
    props:
      operation: read
      sub_type: file
      format: json
      source_details: projects/frontend_auto/generated/sections_data.json

  - label: Load Core Kernel again
    type: db
    position: {x: 1850, y: 400}
    props:
      operation: read
      sub_type: file
      format: json
      source_details: projects/frontend_auto/generated/core_kernel_data.json

  - label: Generate Frontend Code
    type: person_job
    position: {x: 2100, y: 240}
    props:
      person: Frontend Generator
      max_iteration: 100
      memorize_to: "Which contains necessary information for current task, among the previous implementations."
      at_most: 5
      prompt_file: frontend_generator.txt

  - label: Write Section Result
    type: db
    position: {x: 2500, y: 240}
    props:
      operation: write
      sub_type: file
      format: text
      source_details: "projects/frontend_auto/generated/temp_section_{current_index}.tsx"

  - label: Rename Files
    type: code_job
    position: {x: 1850, y: 600}
    props:
      language: python
      filePath: projects/frontend_auto/rename_generated_files.py
      functionName: rename_generated_files

#  - label: Compile Results
#    type: code_job
#    position: {x: 1400, y: 600}
#    props:
#      language: python
#      code: |
#        import json
#        import os
#        from pathlib import Path
#
#        # Read all generated section files
#        generated_dir = Path("projects/frontend_enhance/generated")
#        section_files = sorted(generated_dir.glob("consolidated_section_*.json"))
#
#        all_sections = []
#        for file in section_files:
#          with open(file, 'r') as f:
#            all_sections.append(json.load(f))
#
#        result = {
#          "success": True,
#          "total_sections_processed": len(all_sections),
#          "sections": all_sections,
#          "architecture": sorted_data.get('architecture', {}),
#          "approach": "Sequential processing with intelligent memory selection"
#        }


  - label: End
    type: endpoint
    position: {x: 2100, y: 600}
    props:
      save_to_file: false

connections:
  # Initial setup
  - {from: Start, to: Load Config}
  - {from: Load Config, to: Plan Sections, label: config, content_type: object}
  - {from: Load Config, to: Generate Core Kernel , label: config, content_type: object }

  - {from: Plan Sections, to: Save Sections Data, content_type: object}
  - {from: Plan Sections, to: Generate Core Kernel, label: sections_data, content_type: object}

  - {from: Generate Core Kernel, to: Write Kernel Files, label: kernel, content_type: object}
  - {from: Write Kernel Files, to: Load Sections Data, content_type: object}
  - {from: Load Sections Data, to: Check Continue, label: merged_data, content_type: object}

  # Section iteration loop
  - {from: Check Continue_condfalse, to: Load Sections Data again, content_type: object}
  - {from: Load Sections Data again, to: Load Core Kernel again, label: sections_data, content_type: object}

  - {from: Load Core Kernel again, to: Generate Frontend Code, label: kernel, content_type: object}
  - {from: Generate Frontend Code, to: Write Section Result, content_type: object}
  - {from: Write Section Result, to: Check Continue, content_type: object}

  # Finalization
  - {from: Check Continue_condtrue, to: Rename Files, content_type: object}
  - {from: Rename Files, to: End, content_type: object}
