version: light
nodes:
- label: Start
  type: start
  position: {x: 100, y: 100}
  props:
    trigger_mode: manual
    custom_data:
      session_id: dfc3fc84-a92b-49c0-a3d0-0d59bd4ace86
      initial_prompt: 'Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to.'
- label: User Input 1
  type: person_job
  position: {x: 350, y: 100}
  props:
    person: user
    default_prompt: |-
      <command-name>/clear</command-name>
                  <command-message>clear</command-message>
                  <command-args></command-args>
    max_iteration: 1
- label: User Input 2
  type: person_job
  position: {x: 400, y: 100}
  props:
    person: user
    default_prompt: <local-command-stdout></local-command-stdout>
    max_iteration: 1
- label: Glob Search 3
  type: code_job
  position: {x: 450, y: 100}
  props:
    language: bash
    code: find . -name 'CLAUDE.md' -type f -printf '%T@ %p\n' | sort -rn | cut -d' ' -f2-
    tool: Glob
    description: Glob search operation
- label: Read File 4
  type: db
  position: {x: 500, y: 100}
  props:
    operation: read
    sub_type: file
    file: /home/soryhyun/DiPeO/CLAUDE.md
- label: Read File 5
  type: db
  position: {x: 550, y: 100}
  props:
    operation: read
    sub_type: file
    file: /home/soryhyun/DiPeO/apps/server/CLAUDE.md
- label: Read File 6
  type: db
  position: {x: 600, y: 100}
  props:
    operation: read
    sub_type: file
    file: /home/soryhyun/DiPeO/apps/web/CLAUDE.md
- label: Read File 7
  type: db
  position: {x: 650, y: 100}
  props:
    operation: read
    sub_type: file
    file: /home/soryhyun/DiPeO/dipeo/application/CLAUDE.md
- label: Read File 8
  type: db
  position: {x: 700, y: 100}
  props:
    operation: read
    sub_type: file
    file: /home/soryhyun/DiPeO/dipeo/infrastructure/CLAUDE.md
- label: Read File 9
  type: db
  position: {x: 750, y: 100}
  props:
    operation: read
    sub_type: file
    file: /home/soryhyun/DiPeO/dipeo/domain/CLAUDE.md
- label: Read File 10
  type: db
  position: {x: 800, y: 250}
  props:
    operation: read
    sub_type: file
    file: /home/soryhyun/DiPeO/dipeo/models/CLAUDE.md
- label: Read File 11
  type: db
  position: {x: 850, y: 250}
  props:
    operation: read
    sub_type: file
    file: /home/soryhyun/DiPeO/projects/codegen/CLAUDE.md
- label: User Input 12
  type: person_job
  position: {x: 900, y: 250}
  props:
    person: user
    default_prompt: |2
           1â†’# CLAUDE.md
           2â†’
           3â†’This file provides guidance to Claude Code (claude.ai/code) when working with this DiPeO repository.
           4â†’
           5â†’## Project Overview
           6â†’
           7â†’DiPeO is a monorepo for building and executing AI-powered agent workflows through visual programming:
           8â†’- **Frontend** (apps/web/): React-based visual diagram editor
           9â†’- **Backend** (apps/server/): FastAPI server with GraphQL API
          10â†’- **CLI** (apps/cli/): Command-line tool for running diagrams (`dipeo` command)
          11â†’
          12â†’## ğŸ“š Documentation Structure
          13â†’
          14â†’### Core Documentation
          15â†’- **[Documentation Index](docs/index.md)** - Complete documentation overview
          16â†’- **[User Guide](docs/README.md)** - Getting started with DiPeO
          17â†’- **[Motivations](docs/motivations.md)** - Project background and philosophy
          18â†’- **[CLI Reference](apps/cli/README.md)** - Complete CLI documentation
          19â†’
          20â†’### Architecture & Design
          21â†’- **[Overall Architecture](docs/architecture/overall_architecture.md)** - System architecture and tech stack
          22â†’- **[GraphQL Layer](docs/architecture/graphql-layer.md)** - Complete GraphQL implementation (3-tier)
          23â†’- **[Memory System Design](docs/architecture/memory_system_design.md)** - Conversation memory architecture
          24â†’- **[GraphQL Subscriptions](docs/architecture/graphql-subscriptions.md)** - Real-time updates
          25â†’- **[Diagram Execution](docs/architecture/diagram-execution.md)** - Execution engine details
          26â†’
          27â†’### Diagram Formats
          28â†’- **[Diagram Formats Overview](docs/formats/diagram_formats.md)** - Native, Light, Readable formats
          29â†’- **[Light Diagram Guide](docs/formats/comprehensive_light_diagram_guide.md)** - Complete Light YAML guide â­
          30â†’  - **Essential reading** for working with Light format diagrams
          31â†’  - Includes syntax, examples, best practices
          32â†’
          33â†’### Project Guides
          34â†’- **[Code Generation Guide](docs/projects/code-generation-guide.md)** - Complete codegen pipeline
          35â†’- **[DiPeOCC Guide](docs/projects/dipeocc-guide.md)** - Claude Code session conversion â­
          36â†’- **[DiPeO AI Generation](docs/projects/dipeodipeo-guide.md)** - Natural language to diagrams
          37â†’- **[Frontend Auto](projects/frontend_auto/README.md)** - Rapid AI-powered frontend generation
          38â†’- **[Frontend Enhance](docs/projects/frontend-enhance-guide.md)** - Advanced intelligent memory selection
          39â†’
          40â†’### Integrations
          41â†’- **[Claude Code Integration](docs/integrations/claude-code.md)** - Claude Code SDK integration
          42â†’- **[Webhook Integration](docs/features/webhook-integration.md)** - Webhook support
          43â†’
          44â†’### Node Types
          45â†’- **[Diff Patch Node](docs/nodes/diff-patch.md)** - File modification via diffs
          46â†’
          47â†’## Essential Commands
          48â†’
          49â†’### Setup & Development
          50â†’```bash
          51â†’make install          # Install all dependencies (installs uv if needed)
          52â†’make dev-all          # Start both frontend and backend
          53â†’make dev-server       # Start backend only
          54â†’make dev-web          # Start frontend only
          55â†’```
          56â†’
          57â†’### Running Diagrams
          58â†’```bash
          59â†’dipeo run examples/simple_diagrams/simple_iter --light --debug --timeout=30
          60â†’dipeo run [diagram] --input-data '{"key": "value"}' --light --debug
          61â†’```
          62â†’- **Light diagrams**: Read [Light Diagram Guide](docs/formats/comprehensive_light_diagram_guide.md)
          63â†’- Add `--debug` for detailed logs
          64â†’- Use `simple_iter_cc` diagram to test Claude Code adapter
          65â†’- Monitor at `http://localhost:3000/?monitor=true`
          66â†’
          67â†’### Natural Language to Diagram
          68â†’```bash
          69â†’dipeo ask --to "create a workflow that fetches weather and sends email" --and-run
          70â†’```
          71â†’- See [DiPeO AI Generation Guide](docs/projects/dipeodipeo-guide.md)
          72â†’
          73â†’### Converting Claude Code Sessions
          74â†’```bash
          75â†’dipeocc list                    # List recent Claude Code sessions
          76â†’dipeocc convert --latest        # Convert latest session to diagram
          77â†’dipeocc convert session-id      # Convert specific session
          78â†’dipeocc watch --auto-execute    # Watch and auto-execute new sessions
          79â†’dipeocc stats session-id        # Show session statistics
          80â†’```
          81â†’- **Session location**: `~/.claude/projects/-home-soryhyun-DiPeO/`
          82â†’- **Output**: `projects/claude_code/sessions/{session_id}/`
          83â†’- **Full guide**: [DiPeOCC Guide](docs/projects/dipeocc-guide.md)
          84â†’
          85â†’### Integrations & API Management
          86â†’```bash
          87â†’dipeo integrations init               # Initialize integrations workspace
          88â†’dipeo integrations validate            # Validate provider manifests
          89â†’dipeo integrations openapi-import spec.yaml --name my-api
          90â†’dipeo integrations claude-code --sync-mode auto --watch-todos
          91â†’```
          92â†’
          93â†’## Code Generation
          94â†’
          95â†’**âš ï¸ WARNING**: Code generation overwrites ALL generated code in `dipeo/diagram_generated/`!
          96â†’
          97â†’### Workflow
          98â†’1. **Modify TypeScript specs** in `/dipeo/models/src/`, then: `cd dipeo/models && pnpm build`
          99â†’2. **Generate**: `make codegen` (includes parse-typescript automatically)
         100â†’3. **Verify**: `make diff-staged` to review changes
         101â†’4. **Apply**: Choose one:
         102â†’   - `make apply-syntax-only` - Applies staged â†’ active with syntax validation only (fastest, minimal safety)
         103â†’   - `make apply` - Applies staged â†’ active with full type checking (safer but slower)
         104â†’   - `make apply-test` - Applies staged â†’ active after full server validation (strongest safety, ensures server can actually run)
         105â†’5. **Update GraphQL**: `make graphql-schema`
         106â†’
         107â†’Quick command: `make codegen-auto` (runs all steps - USE WITH CAUTION)
         108â†’
         109â†’### Staging System
         110â†’- **Generated to**: `dipeo/diagram_generated_staged/` (for review - temporary staging area)
         111â†’- **Active code**: `dipeo/diagram_generated/` (in use - DO NOT EDIT DIRECTLY)
         112â†’- **Apply changes**: Three validation levels available:
         113â†’  - `make apply-syntax-only` - Syntax validation only (fastest)
         114â†’  - `make apply` - Full type checking (comprehensive validation)
         115â†’  - `make apply-test` - Complete server startup test with staged code (includes critical imports, server health, GraphQL endpoint testing)
         116â†’- **Why staging**: Safety, validation, easy rollback
         117â†’- **Full docs**: [Code Generation Guide](docs/projects/code-generation-guide.md)
         118â†’
         119â†’## GraphQL Operations System
         120â†’
         121â†’### ğŸ‰ Implementation Status: COMPLETE
         122â†’The GraphQL refactoring is **substantially complete** with a solid, production-ready architecture:
         123â†’- âœ… **45 complete operations** with full GraphQL query strings as constants
         124â†’- âœ… **Type-safe operation classes** with proper TypedDict for variables
         125â†’- âœ… **Well-structured resolvers** following consistent patterns
         126â†’- âœ… **Clean 3-tier architecture** separating concerns
         127â†’- âœ… **ServiceRegistry integration** for dependency injection
         128â†’- âœ… **No major refactoring needed** - architecture is solid and maintainable
         129â†’
         130â†’### Architecture Overview (3-Tier System)
         131â†’1. **Generated Layer** (`/dipeo/diagram_generated/graphql/`)
         132â†’   - `operations.py` - All 45 operations with full support
         133â†’   - `inputs.py`, `results.py`, `domain_types.py`, `enums.py` - Generated types
         134â†’
         135â†’2. **Application Layer** (`/dipeo/application/graphql/`)
         136â†’   - `schema/mutations/` - Organized by entity type
         137â†’   - `schema/query_resolvers.py` - Standalone query resolvers
         138â†’   - `operation_executor.py` - Central operation mapping
         139â†’
         140â†’3. **Execution Layer** (Infrastructure)
         141â†’   - EnhancedServiceRegistry for advanced dependency injection
         142â†’   - Event-driven state management
         143â†’   - Envelope system for type-safe data flow
         144â†’
         145â†’### Adding New GraphQL Operations
         146â†’1. **Add definition** to `/dipeo/models/src/frontend/query-definitions/[entity].ts`
         147â†’2. **Build models**: `cd dipeo/models && pnpm build`
         148â†’3. **Generate queries**: `make codegen`
         149â†’4. **Apply changes**: `make apply-test`
         150â†’5. **Update GraphQL schema**: `make graphql-schema`
         151â†’
         152â†’### Query Definition Structure
         153â†’```typescript
         154â†’// In /dipeo/models/src/frontend/query-definitions/[entity].ts
         155â†’export const entityQueries: EntityQueryDefinitions = {
         156â†’  entity: 'EntityName',
         157â†’  queries: [
         158â†’    {
         159â†’      name: 'GetEntity',
         160â†’      type: QueryOperationType.QUERY,
         161â†’      variables: [{ name: 'id', type: 'ID', required: true }],
         162â†’      fields: [/* GraphQL fields */]
         163â†’    }
         164â†’  ]
         165â†’}
         166â†’```
         167â†’
         168â†’### Generated Files & Operations
         169â†’- **Frontend Queries**: `/apps/web/src/__generated__/queries/all-queries.ts` - All GraphQL operations
         170â†’- **React Hooks**: `/apps/web/src/__generated__/graphql.tsx` - Type-safe hooks for each operation
         171â†’- **Python Operations**: `/dipeo/diagram_generated/graphql/operations.py` - Typed Python classes
         172â†’- **45 operations** currently defined (23 queries, 21 mutations, 1 subscription)
         173â†’
         174â†’### Usage in Frontend
         175â†’```typescript
         176â†’// Import generated hooks
         177â†’import { useGetExecutionQuery } from '@/__generated__/graphql';
         178â†’
         179â†’// Use in components
         180â†’const { data, loading } = useGetExecutionQuery({
         181â†’  variables: { id: executionId }
         182â†’});
         183â†’```
         184â†’
         185â†’### Usage in Python
         186â†’
         187â†’```python
         188â†’# Import generated operations
         189â†’from dipeo.diagram_generated.graphql_backups.operations import (
         190â†’    ExecuteDiagramOperation,
         191â†’    GetExecutionOperation,
         192â†’    EXECUTE_DIAGRAM_MUTATION
         193â†’)
         194â†’
         195â†’# Use query strings directly
         196â†’query = EXECUTE_DIAGRAM_MUTATION
         197â†’
         198â†’# Or use typed operation classes
         199â†’variables = ExecuteDiagramOperation.get_variables_dict(
         200â†’    input={"diagram_id": "example", "variables": {}}
         201â†’)
         202â†’```
         203â†’
         204â†’### Key Benefits of Current Implementation
         205â†’- **Type Safety**: Full type safety from TypeScript to Python
         206â†’- **Consistency**: All resolvers follow established patterns
         207â†’- **Maintainability**: Clean separation of concerns
         208â†’- **Performance**: Optimized with per-execution caching
         209â†’- **Developer Experience**: Auto-completion and inline documentation
         210â†’
         211â†’For detailed architecture documentation, see [GraphQL Layer Architecture](docs/architecture/graphql-layer.md)
         212â†’
         213â†’## Quality Commands
         214â†’```bash
         215â†’make lint-server        # Lint Python
         216â†’make lint-web           # Lint TypeScript
         217â†’make format             # Format Python with ruff
         218â†’pnpm typecheck          # TypeScript type checking
         219â†’make graphql-schema     # Update GraphQL types
         220â†’```
         221â†’
         222â†’## Architecture Overview
         223â†’
         224â†’### Key Concepts
         225â†’- **Code Generation**: All models/schemas generated from TypeScript specs in `/dipeo/models/src/`
         226â†’- **Generated Code**: Lives in `dipeo/diagram_generated/` (DO NOT EDIT DIRECTLY)
         227â†’- **Diagrams**: Stored in `/examples/`, `/projects/`, or `/files/`
         228â†’- **Service Architecture**: Mixin-based composition (LoggingMixin, ValidationMixin, ConfigurationMixin, CachingMixin, InitializationMixin)
         229â†’- **Event System**: Unified EventBus protocol for all event handling
         230â†’- **Output Pattern**: Envelope pattern with EnvelopeFactory for all handler outputs
         231â†’
         232â†’### Key Architecture Documentation
         233â†’- **[Overall Architecture](docs/architecture/overall_architecture.md)** - Complete system design
         234â†’- **[Memory System](docs/architecture/memory_system_design.md)** - Conversation memory management
         235â†’- **[Diagram Execution](docs/architecture/diagram-execution.md)** - Execution flow details
         236â†’- **[GraphQL Layer](docs/architecture/graphql-layer.md)** - GraphQL implementation
         237â†’
         238â†’### Node Handlers - Path Reference
         239â†’**Base Directory**: `/dipeo/application/execution/handlers/`
         240â†’
         241â†’#### Individual Node Handlers (Direct Files)
         242â†’- `api_job.py` - API call handling
         243â†’- `db.py` - Database operations
         244â†’- `endpoint.py` - HTTP endpoint handling
         245â†’- `hook.py` - Hook/callback handling
         246â†’- `integrated_api.py` - Integrated API operations ([Integration Guide](docs/integrations/claude-code.md))
         247â†’- `json_schema_validator.py` - JSON schema validation
         248â†’- `start.py` - Start node handling
         249â†’- `template_job.py` - Template processing
         250â†’- `typescript_ast.py` - TypeScript AST operations
         251â†’- `user_response.py` - User response handling
         252â†’
         253â†’#### Complex Node Handlers (Subdirectories)
         254â†’- **person_job/** - LLM/AI agent handling
         255â†’  - `batch_executor.py` - Batch person execution
         256â†’  - `conversation_handler.py` - Conversation management
         257â†’  - `prompt_resolver.py` - Prompt resolution
         258â†’  - `text_format_handler.py` - Text formatting
         259â†’- **sub_diagram/** - Sub-diagram execution
         260â†’  - `lightweight_executor.py` - Light diagram execution
         261â†’  - `single_executor.py` - Single sub-diagram execution
         262â†’  - `batch_executor.py` - Batch sub-diagram execution
         263â†’  - `parallel_executor.py` - Parallel execution
         264â†’  - `base_executor.py` - Base executor logic
         265â†’- **code_job/** - Code execution
         266â†’  - `executors/` - Various code executors
         267â†’- **condition/** - Conditional logic
         268â†’  - `evaluators/` - Condition evaluators
         269â†’
         270â†’### Key Directories
         271â†’- `/apps/server/` - FastAPI backend
         272â†’- `/apps/web/` - React frontend ([Frontend README](apps/web/src/domain/README.md))
         273â†’- `/apps/cli/` - CLI tool ([CLI Documentation](apps/cli/README.md))
         274â†’- `/dipeo/` - Backend business logic (application/domain/infrastructure layers)
         275â†’- `/projects/codegen/` - Code generation system ([Codegen Guide](docs/projects/code-generation-guide.md))
         276â†’- `/projects/frontend_auto/` - AI frontend generation ([Frontend Auto](projects/frontend_auto/README.md))
         277â†’- `/projects/frontend_enhance/` - Advanced frontend generation ([Frontend Enhance](docs/projects/frontend-enhance-guide.md))
         278â†’
         279â†’### LLM Infrastructure (Updated 2025)
         280â†’- **Unified Client Architecture**: All providers use unified clients directly (no adapter/client separation)
         281â†’- **OpenAI API v2 Migration**:
         282â†’  - Uses new `responses.create()` and `responses.parse()` APIs
         283â†’  - `messages` â†’ `input` parameter
         284â†’  - `max_tokens` â†’ `max_output_tokens`
         285â†’  - Temperature parameter no longer supported
         286â†’  - Response structure: `response.output[0].content[0].text`
         287â†’- **Domain Adapters**:
         288â†’  - `LLMMemorySelectionAdapter`: Intelligent memory filtering and selection
         289â†’  - `LLMDecisionAdapter`: Binary decision making for conditions
         290â†’- **Provider Support**: OpenAI, Anthropic, Google, Ollama, Claude Code
         291â†’- **Documentation**: [Claude Code Integration](docs/integrations/claude-code.md)
         292â†’
         293â†’## Enhanced Service Registry
         294â†’
         295â†’### Overview
         296â†’DiPeO uses an **EnhancedServiceRegistry** for advanced dependency injection with production safety features and comprehensive service management. This replaces the basic ServiceRegistry with enhanced capabilities for enterprise-grade service orchestration.
         297â†’
         298â†’### Key Features
         299â†’
         300â†’#### Service Type Categorization
         301â†’All services are categorized by type for better organization and validation:
         302â†’- **CORE**: Essential system services (EVENT_BUS, STATE_STORE)
         303â†’- **APPLICATION**: Application-layer services (handlers, executors)
         304â†’- **DOMAIN**: Domain logic services (business rules, validators)
         305â†’- **ADAPTER**: External integrations (LLM clients, databases)
         306â†’- **REPOSITORY**: Data access services (persistence layers)
         307â†’
         308â†’#### Production Safety
         309â†’- **Registry Freezing**: Automatically freezes in production after bootstrap to prevent accidental modifications
         310â†’- **Final Services**: Critical services marked as final cannot be overridden (EVENT_BUS)
         311â†’- **Immutable Services**: Core services marked as immutable cannot be modified (STATE_STORE)
         312â†’- **Environment Detection**: Automatically detects production environment and applies safety constraints
         313â†’
         314â†’#### Audit Trail & Debugging
         315â†’- **Registration History**: Complete audit trail of all service registrations with timestamps
         316â†’- **Dependency Validation**: Validates service dependencies and detects circular references
         317â†’- **Usage Metrics**: Tracks service retrieval patterns for performance optimization
         318â†’- **Service Health**: Monitors service lifecycle and availability
         319â†’
         320â†’### Usage Examples
         321â†’
         322â†’#### Basic Service Registration
         323â†’```python
         324â†’from dipeo.infrastructure.enhanced_service_registry import EnhancedServiceRegistry, ServiceType
         325â†’
         326â†’registry = EnhancedServiceRegistry()
         327â†’
         328â†’# Register with type categorization
         329â†’registry.register("my_service", my_service_instance, ServiceType.APPLICATION)
         330â†’
         331â†’# Register with special markers
         332â†’registry.register("critical_service", service, ServiceType.CORE, final=True)
         333â†’registry.register("config_service", config, ServiceType.DOMAIN, immutable=True)
         334â†’```
         335â†’
         336â†’#### Audit Trail Access
         337â†’```python
         338â†’# Get registration history for debugging
         339â†’history = registry.get_audit_trail()
         340â†’for entry in history:
         341â†’    print(f"{entry.timestamp}: {entry.action} - {entry.service_name} ({entry.service_type})")
         342â†’
         343â†’# Get service usage metrics
         344â†’metrics = registry.get_service_metrics("EVENT_BUS")
         345â†’print(f"Retrieved {metrics.retrieval_count} times")
         346â†’```
         347â†’
         348â†’#### Service Validation
         349â†’```python
         350â†’# Validate all dependencies before production deployment
         351â†’validation_result = registry.validate_dependencies()
         352â†’if not validation_result.is_valid:
         353â†’    for error in validation_result.errors:
         354â†’        print(f"Dependency error: {error}")
         355â†’
         356â†’# Check if registry is properly configured
         357â†’if registry.is_frozen:
         358â†’    print("Registry is production-ready and frozen")
         359â†’```
         360â†’
         361â†’#### Protected Services
         362â†’```python
         363â†’# Critical services are automatically protected
         364â†’registry.get("EVENT_BUS")    # Always available, final service
         365â†’registry.get("STATE_STORE")  # Always available, immutable service
         366â†’
         367â†’# These services cannot be modified in production:
         368â†’# - EVENT_BUS (final): Cannot be overridden
         369â†’# - STATE_STORE (immutable): Cannot be modified
         370â†’```
         371â†’
         372â†’### Integration with Existing Architecture
         373â†’- **Mixin Compatibility**: Works seamlessly with existing service mixins
         374â†’- **EventBus Integration**: EVENT_BUS service is automatically protected as final
         375â†’- **StateStore Protection**: STATE_STORE marked as immutable for data integrity
         376â†’- **GraphQL Layer**: Integrates with GraphQL resolvers for dependency injection
         377â†’
         378â†’### Best Practices
         379â†’1. **Use Type Categories**: Always specify ServiceType when registering services
         380â†’2. **Mark Critical Services**: Use `final=True` for services that should never be overridden
         381â†’3. **Protect Core State**: Use `immutable=True` for configuration and state services
         382â†’4. **Monitor in Development**: Use audit trail to debug service dependency issues
         383â†’5. **Validate Before Production**: Always run dependency validation before deployment
         384â†’
         385â†’### Migration from Basic ServiceRegistry
         386â†’The migration is automatic - existing code continues to work with enhanced features available:
         387â†’```python
         388â†’# Old code still works
         389â†’registry.register("service", instance)
         390â†’service = registry.get("service")
         391â†’
         392â†’# Enhanced features available
         393â†’registry.register("service", instance, ServiceType.APPLICATION, final=True)
         394â†’history = registry.get_audit_trail()
         395â†’```
         396â†’
         397â†’## Adding New Features
         398â†’
         399â†’### New Node Types
         400â†’1. Create specification in `/dipeo/models/src/node-specs/`
         401â†’2. Build models: `cd dipeo/models && pnpm build`
         402â†’3. Generate: `make codegen`
         403â†’4. Apply: `make apply-test`
         404â†’5. Update GraphQL: `make graphql-schema`
         405â†’6. See: [Code Generation Guide](docs/projects/code-generation-guide.md)
         406â†’
         407â†’### Other Changes
         408â†’- **API changes**: Modify GraphQL schema, then `make graphql-schema`
         409â†’- **UI changes**: Work in `/apps/web/src/`
         410â†’- **Documentation**: [GraphQL Layer](docs/architecture/graphql-layer.md)
         411â†’
         412â†’## Important Notes
         413â†’
         414â†’- **Python 3.13+** required
         415â†’- Use **uv** for Python, **pnpm** for JavaScript (not npm/yarn)
         416â†’- Default LLM: `gpt-5-nano-2025-08-07`
         417â†’- Backend port: 8000, Frontend port: 3000
         418â†’- **v1.0 Refactoring Complete**: Services use mixin composition, unified EventBus, complete Envelope migration
         419â†’- **Enhanced Service Registry**: Production-ready dependency injection with type categorization, audit trails, and safety features
         420â†’
         421â†’## Common Issues & Solutions
         422â†’
         423â†’| Issue | Solution | Documentation |
         424â†’|---|---|---|
         425â†’| Import errors | Run `make install` (uv manages activation automatically) | |
         426â†’| uv not found | `make install` (auto-installs uv) | |
         427â†’| Generated code out of sync | Run codegen workflow (see above) | [Codegen Guide](docs/projects/code-generation-guide.md) |
         428â†’| TypeScript errors | `make graphql-schema` | |
         429â†’| Need debugging | Add `--debug` flag, check `.logs/` | |
         430â†’| OpenAI temperature error | Temperature not supported in new API, remove parameter | |
         431â†’| OpenAI max_tokens error | Use `max_output_tokens` instead of `max_tokens` | |
         432â†’| TokenUsage missing 'total' | Use `total_tokens` property instead | |
         433â†’| Claude Code sessions | Use `dipeocc` to convert sessions | [DiPeOCC Guide](docs/projects/dipeocc-guide.md) |
         434â†’
         435â†’## Testing & Debugging
         436â†’
         437â†’- **Debug diagrams**: `dipeo run [diagram] --debug`
         438â†’- **Monitor UI**: `http://localhost:3000/?monitor=true`
         439â†’- **GraphQL playground**: `http://localhost:8000/graphql`
         440â†’- **Logs**: Check `.logs/server.log` for detailed debugging
         441â†’- **Note**: Formal test suite is under development
         442â†’

      <system-reminder>
      Whenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.
      </system-reminder>
    max_iteration: 1
- label: User Input 13
  type: person_job
  position: {x: 950, y: 250}
  props:
    person: user
    default_prompt: |2
           1â†’# DiPeO Server
           2â†’
           3â†’The backend API server for DiPeO, providing GraphQL and REST endpoints for diagram execution and management.
           4â†’
           5â†’## Architecture
           6â†’
           7â†’```
           8â†’apps/server/
           9â†’â”œâ”€â”€ src/dipeo_server/
          10â†’â”‚   â”œâ”€â”€ api/           # FastAPI/GraphQL adapters
          11â†’â”‚   â”œâ”€â”€ infra/         # Infrastructure (state storage, caching)
          12â†’â”‚   â””â”€â”€ app_context.py # Container configuration
          13â†’â”œâ”€â”€ main.py            # Server entry point
          14â†’â”œâ”€â”€ main_bundled.py    # PyInstaller entry point
          15â†’â””â”€â”€ schema.graphql     # GraphQL schema
          16â†’```
          17â†’
          18â†’## Key Components
          19â†’
          20â†’### API Layer (`api/`)
          21â†’- **GraphQL Router**: Strawberry-based GraphQL with subscriptions
          22â†’- **SSE Endpoints**: Direct streaming for real-time execution updates
          23â†’- **Context Management**: Request-scoped dependency injection
          24â†’
          25â†’### Infrastructure (`infra/`)
          26â†’- **StateRegistry**: SQLite-based execution state persistence
          27â†’- **ExecutionCache**: In-memory cache for active executions
          28â†’- **MessageStore**: Conversation history storage
          29â†’
          30â†’### Container System
          31â†’Uses simplified 3-container architecture:
          32â†’- **CoreContainer**: Domain services (validators, utilities)
          33â†’- **InfrastructureContainer**: External adapters (storage, LLM)
          34â†’- **ApplicationContainer**: Use cases and orchestration
          35â†’
          36â†’## Running the Server
          37â†’
          38â†’```bash
          39â†’# Development
          40â†’make dev-server              # Runs on port 8000
          41â†’
          42â†’# Production (multi-worker)
          43â†’WORKERS=4 python main.py     # Hypercorn with 4 workers
          44â†’
          45â†’# Bundled executable
          46â†’make build-server           # Creates standalone executable
          47â†’./dist/dipeo-server         # Run bundled server
          48â†’```
          49â†’
          50â†’## GraphQL Endpoints
          51â†’
          52â†’- **Playground**: http://localhost:8000/graphql
          53â†’- **Queries**: Diagrams, executions, persons, API keys
          54â†’- **Mutations**: CRUD operations, diagram execution
          55â†’- **Subscriptions**: Real-time execution updates
          56â†’
          57â†’## Environment Variables
          58â†’
          59â†’- `PORT`: Server port (default: 8000)
          60â†’- `WORKERS`: Number of worker processes (default: 4)
          61â†’- `REDIS_URL`: Redis for multi-worker subscriptions (optional)
          62â†’- `STATE_STORE_PATH`: SQLite database path
          63â†’- `LOG_LEVEL`: Logging verbosity (INFO/DEBUG)
          64â†’
          65â†’## SSE Streaming
          66â†’
          67â†’Direct streaming endpoint for browser clients:
          68â†’```
          69â†’GET /sse/executions/{execution_id}
          70â†’```
          71â†’
          72â†’Provides real-time execution updates without WebSocket complexity.
          73â†’

      <system-reminder>
      Whenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.
      </system-reminder>
    max_iteration: 1
- label: User Input 14
  type: person_job
  position: {x: 1000, y: 250}
  props:
    person: user
    default_prompt: "     1â†’# Web Frontend\n     2â†’\n     3â†’React-based visual diagram editor for DiPeO.\n     4â†’\n     5â†’## Tech Stack\n     6â†’- React 19 + TypeScript + Vite\n     7â†’- XYFlow (diagram editing)\n     8â†’- Apollo Client (GraphQL)\n     9â†’- Zustand (state management)\n    10â†’- TailwindCSS + React Hook Form + Zod\n    11â†’\n    12â†’## Commands\n    13â†’```bash\n    14â†’pnpm dev                # Start dev server (localhost:3000)\n    15â†’pnpm build              # Production build\n    16â†’pnpm typecheck          # TypeScript checking\n    17â†’pnpm codegen            # Generate GraphQL types\n    18â†’pnpm lint:fix           # Auto-fix linting\n    19â†’```\n    20â†’\n    21â†’## Architecture\n    22â†’```\n    23â†’/apps/web/src/\n    24â†’â”œâ”€â”€ __generated__/      # Generated GraphQL types (DO NOT EDIT)\n    25â†’â”œâ”€â”€ domain/             # Business logic by domain\n    26â†’â”‚   â”œâ”€â”€ diagram/        # Diagram editing, properties, personas\n    27â†’â”‚   â””â”€â”€ execution/      # Execution monitoring, conversations\n    28â†’â”œâ”€â”€ infrastructure/     # Technical services\n    29â†’â”‚   â”œâ”€â”€ store/          # Zustand state management\n    30â†’â”‚   â””â”€â”€ hooks/          # Cross-cutting hooks\n    31â†’â”œâ”€â”€ lib/graphql/        # GraphQL client\n    32â†’â””â”€â”€ ui/                 # Presentation layer\n    33â†’    â””â”€â”€ components/     # UI components\n    34â†’```\n    35â†’\n    36â†’### Key Imports\n    37â†’```typescript\n    38â†’// Domain hooks & services\n    39â†’import { useDiagramManager } from '@/domain/diagram';\n    40â†’import { useExecution } from '@/domain/execution';\n    41â†’import { useStore } from '@/infrastructure/store';\n    42â†’\n    43â†’// Generated GraphQL\n    44â†’import { useGetDiagramQuery } from '@/__generated__/graphql';\n    45â†’```\n    46â†’\n    47â†’## Key Concepts\n    48â†’\n    49â†’### State Management (Zustand)\n    50â†’- Flattened store with slices: `diagram`, `execution`, `person`, `ui`\n    51â†’- Access via hooks: `useStore()`\n    52â†’- Factory patterns for CRUD operations\n    53â†’\n    54â†’### GraphQL\n    55â†’- Queries in `/lib/graphql/queries/`\n    56â†’- Generated hooks in `/__generated__/`\n    57â†’- Real-time subscriptions for updates\n    58â†’\n    59â†’### Node System\n    60â†’- Configs generated from TypeScript specs\n    61â†’- Components in `/ui/components/diagram/nodes/`\n    62â†’- Base classes: `BaseNode`, `ConfigurableNode`\n    63â†’\n    64â†’### Forms\n    65â†’- React Hook Form + Zod validation\n    66â†’- Auto-save with debouncing\n    67â†’- Dynamic field rendering\n    68â†’\n    69â†’## Development Patterns\n    70â†’\n    71â†’### Components\n    72â†’```typescript\n    73â†’// Named exports via index.ts\n    74â†’export { MyComponent } from './MyComponent';\n    75â†’\n    76â†’// Composition over inheritance\n    77â†’const EnhancedNode = withRightClickDrag(BaseNode);\n    78â†’```\n    79â†’\n    80â†’### State & GraphQL\n    81â†’```typescript\n    82â†’// Zustand updates\n    83â†’set((state) => { state.nodes[nodeId] = data; });\n    84â†’\n    85â†’// GraphQL hooks\n    86â†’const { data, loading } = useGetDiagramQuery({ \n    87â†’  variables: { id },\n    88â†’  skip: !id \n    89â†’});\n    90â†’```\n    91â†’\n    92â†’### Styling\n    93â†’- TailwindCSS utilities\n    94â†’- Dark mode via CSS variables\n    95â†’\n    96â†’\n    97â†’## Infrastructure Services\n    98â†’\n    99â†’| Service | Purpose | Location |\n   100â†’|---------|---------|----------|\n   101â†’| ConversionService | Type conversions, GraphQL transforms | `/infrastructure/converters/` |\n   102â†’| NodeService | Node specs, field configs | `/infrastructure/services/` |\n   103â†’| ValidationService | Zod validation, error messages | `/infrastructure/services/` |\n   104â†’\n   105â†’\n   106â†’## Common Patterns\n   107â†’\n   108â†’```typescript\n   109â†’// Custom hooks\n   110â†’function useDiagramManager() {\n   111â†’  const store = useStore();\n   112â†’  return { diagram: store.diagram, save: () => {} };\n   113â†’}\n   114â†’\n   115â†’// Factory functions\n   116â†’const createNodeConfig = (spec: NodeSpec): NodeConfig => ({ \n   117â†’  type: spec.type, \n   118â†’  fields: generateFields(spec) \n   119â†’});\n   120â†’\n   121â†’// Error boundaries\n   122â†’<ErrorBoundary fallback={<ErrorFallback\
      \ />}>\n   123â†’  <DiagramEditor />\n   124â†’</ErrorBoundary>\n   125â†’```\n   126â†’\n   127â†’## Important Notes\n   128â†’\n   129â†’- **Never edit generated files** - Modify TypeScript specs and run codegen\n   130â†’- **Use pnpm** for package management\n   131â†’- **Maintain type safety** - avoid `any` types\n   132â†’- **Extract complex logic** to hooks\n   133â†’\n   134â†’## URL Parameters\n   135â†’\n   136â†’- `?diagram={format}/{filename}` - Load diagram\n   137â†’- `?monitor=true` - Monitor mode\n   138â†’- `?debug=true` - Debug mode\n   139â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"
    max_iteration: 1
- label: User Input 15
  type: person_job
  position: {x: 1050, y: 250}
  props:
    person: user
    default_prompt: "     1â†’# Application Layer\n     2â†’\n     3â†’Orchestrates business logic between domain and infrastructure layers.\n     4â†’\n     5â†’## Architecture\n     6â†’- **3-container DI**: Application â†’ Infrastructure â†’ Core\n     7â†’- **Event-driven**: Asynchronous communication via unified EventBus\n     8â†’- **Type-safe**: ServiceRegistry with compile-time guarantees\n     9â†’- **Mixin-based Services**: Optional composition with LoggingMixin, ValidationMixin, ConfigurationMixin, CachingMixin, InitializationMixin\n    10â†’\n    11â†’## Directory Structure\n    12â†’\n    13â†’### Bootstrap (`bootstrap/`)\n    14â†’- **application_container.py**: Main application container orchestration\n    15â†’- **infrastructure_container.py**: Infrastructure service initialization\n    16â†’- **containers.py**: Core container management and lifecycle\n    17â†’- **service_registry.py**: Type-safe service locator implementation\n    18â†’- **wiring.py**: Dependency injection wiring configuration\n    19â†’- **lifecycle.py**: Component lifecycle protocols\n    20â†’- **port_metrics.py**: Performance metrics tracking\n    21â†’\n    22â†’### Execution Engine (`execution/`)\n    23â†’- **engine.py**: TypedExecutionEngine - event-driven node execution\n    24â†’- **orchestrators/**: Central coordination for execution concerns\n    25â†’  - Person management with unified caching\n    26â†’  - Prompt loading delegation\n    27â†’  - Memory selection via LLMMemorySelector\n    28â†’  - LLM decision execution\n    29â†’- **handlers/**: Node-specific execution handlers\n    30â†’  - Simple handlers: Single file (e.g., `start.py`, `api_job.py`, `db.py`)\n    31â†’  - Complex handlers: Package structure (e.g., `person_job/`, `code_job/`, `sub_diagram/`)\n    32â†’- **states/**: Execution state management\n    33â†’- **observers/**: Event observation and monitoring\n    34â†’- **use_cases/**: Business logic use cases\n    35â†’\n    36â†’### GraphQL API (`graphql/`)\n    37â†’- **schema/**: GraphQL schema definitions\n    38â†’  - queries.py: Query resolvers\n    39â†’  - mutations/: Mutation implementations\n    40â†’  - subscriptions.py: Real-time subscriptions\n    41â†’- **resolvers/**: Business logic resolvers\n    42â†’- **types/**: GraphQL type definitions\n    43â†’- **schema_factory.py**: Schema assembly\n    44â†’\n    45â†’### Conversation Management (`conversation/`)\n    46â†’- **wiring.py**: Conversation context dependency injection\n    47â†’- **use_cases/manage_conversation.py**: Conversation lifecycle management\n    48â†’\n    49â†’### Diagram Operations (`diagram/`)\n    50â†’- **wiring.py**: Diagram service dependency injection\n    51â†’- **use_cases/**: Diagram-specific operations\n    52â†’  - compile_diagram.py: Diagram compilation logic\n    53â†’  - load_diagram.py: Loading from various sources\n    54â†’  - serialize_diagram.py: Format conversion\n    55â†’  - validate_diagram.py: Structure validation\n    56â†’\n    57â†’### Registry (`registry/`)\n    58â†’- **service_registry.py**: Type-safe service locator\n    59â†’- **keys.py**: Service key definitions\n    60â†’\n    61â†’### Utilities (`utils/`)\n    62â†’- **prompt_builder.py**: Dynamic prompt construction\n    63â†’\n    64â†’## Service Registry\n    65â†’```python\n    66â†’# Type-safe service registration\n    67â†’LLM_SERVICE = ServiceKey[\"LLMServicePort\"](\"llm_service\")\n    68â†’registry.register(LLM_SERVICE, llm_service_instance)\n    69â†’llm_service = registry.resolve(LLM_SERVICE)  # Type-safe\n    70â†’```\n    71â†’\n    72â†’## Event Architecture\n    73â†’\n    74â†’- **AsyncEventBus**: Fire-and-forget event distribution\n    75â†’- **CacheFirstStateStore**: Cache-first persistence with Phase 4 optimizations\n    76â†’- **Benefits**: No global locks, true parallel execution, clean separation\n    77â†’\n    78â†’## Execution Flow\n    79â†’1. Compile diagram (uses CompileTimeResolver for connections)\n    80â†’2. Auto-register handlers\n    81â†’3. Initialize event bus\n    82â†’4. Execute loop:\n    83â†’   - Calculate ready nodes (DomainDynamicOrderCalculator)\n    84â†’   - Resolve inputs (domain.execution.resolution.api.resolve_inputs)\n    85â†’   - Execute handlers\n    86â†’   - Emit\
      \ events (async persistence)\n    87â†’5. Handle errors via events\n    88â†’\n    89â†’## Node Handlers\n    90â†’\n    91â†’```python\n    92â†’@register_handler\n    93â†’class PersonJobNodeHandler(TypedNodeHandler[PersonJobNode]):\n    94â†’    async def execute_request(self, request: ExecutionRequest) -> Envelope:\n    95â†’        # Use orchestrator for person management\n    96â†’        person = await self.orchestrator.get_or_create_person(person_id)\n    97â†’        \n    98â†’        # Return output using EnvelopeFactory\n    99â†’        return EnvelopeFactory.create(\n   100â†’            body=result_data,\n   101â†’            produced_by=str(node.id),\n   102â†’            trace_id=request.execution_id\n   103â†’        )\n   104â†’```\n   105â†’\n   106â†’- Auto-discovered via `@register_handler` decorator\n   107â†’- Receive: node instance, context, inputs, services\n   108â†’- Return Envelope objects using EnvelopeFactory\n   109â†’- Support single-file or package structure\n   110â†’- Use ExecutionOrchestrator for person/memory/prompt management\n   111â†’\n   112â†’### Output Handling\n   113â†’\n   114â†’All handlers use the **Envelope pattern**:\n   115â†’\n   116â†’```python\n   117â†’# Text output\n   118â†’EnvelopeFactory.create(content, produced_by=node_id, trace_id=trace_id)\n   119â†’\n   120â†’# JSON/object output  \n   121â†’EnvelopeFactory.create(data, produced_by=node_id, trace_id=trace_id)\n   122â†’\n   123â†’# Binary output\n   124â†’EnvelopeFactory.create(bytes_data, produced_by=node_id, trace_id=trace_id)\n   125â†’\n   126â†’# Error output\n   127â†’EnvelopeFactory.create(msg, error=\"Error\", produced_by=node_id, trace_id=trace_id)\n   128â†’\n   129â†’# With multiple representations\n   130â†’envelope = EnvelopeFactory.create(data, produced_by=node_id, trace_id=trace_id)\n   131â†’envelope = envelope.with_representations({\n   132â†’    \"text\": str(data),\n   133â†’    \"object\": data,\n   134â†’    \"markdown\": format_as_markdown(data)\n   135â†’})\n   136â†’```\n   137â†’\n   138â†’Benefits:\n   139â†’- **Type safety**: Content-type aware transformations\n   140â†’- **Multiple representations**: Same data in different formats\n   141â†’- **Clean API**: Consistent interface across all handlers\n   142â†’- **Traceability**: Built-in trace_id and produced_by metadata\n   143â†’\n   144â†’## Design Principles\n   145â†’1. **Separation of Concerns**: Domain (logic) â†â†’ Application (orchestration) â†â†’ Infrastructure (I/O)\n   146â†’2. **Dependency Injection**: Via ServiceRegistry\n   147â†’3. **Type Safety**: Compile-time guarantees\n   148â†’4. **Event-Driven**: Async, decoupled communication\n   149â†’5. **Extensibility**: Add handlers for new node types\n   150â†’6. **Single Source of Truth**: ExecutionOrchestrator for execution-time concerns\n   151â†’7. **Context-First**: Access execution context directly (e.g., `context.diagram`)\n   152â†’\n   153â†’\n   154â†’## Integration Points\n   155â†’\n   156â†’**Domain Layer**:\n   157â†’- `dipeo.domain.diagram.compilation` - Compile-time resolution\n   158â†’- `dipeo.domain.execution.resolution` - Runtime input resolution\n   159â†’- `dipeo.domain.events` - Event contracts\n   160â†’- `dipeo.domain.ports.storage` - Storage interfaces\n   161â†’\n   162â†’**Infrastructure Layer**:\n   163â†’- AsyncEventBus, CacheFirstStateStore, MessageRouter\n   164â†’\n   165â†’**Server Layer**:\n   166â†’- GraphQL/REST adapters, event bus initialization\n   167â†’\n   168â†’## Key Imports\n   169â†’\n   170â†’```python\n   171â†’from dipeo.domain.execution.resolution import RuntimeInputResolver, TransformationEngine\n   172â†’from dipeo.domain.execution.envelope import EnvelopeFactory\n   173â†’from dipeo.domain.diagram.compilation import CompileTimeResolver, Connection\n   174â†’from dipeo.domain.events import EventType, ExecutionEvent\n   175â†’from dipeo.domain.ports.storage import FileSystemPort\n   176â†’from dipeo.domain.integrations.api_services import APIBusinessLogic\n   177â†’from dipeo.application.execution.orchestrators import ExecutionOrchestrator\n   178â†’from dipeo.application.execution.use_cases import PromptLoadingUseCase\n   179â†’```\n   180â†’\n   181â†’## Diagram Access Patterns\n   182â†’\n   183â†’### âœ… DO: Use\
      \ diagram query methods\n   184â†’Always use ExecutableDiagram's built-in query methods for accessing diagram data:\n   185â†’\n   186â†’```python\n   187â†’# Get a specific node\n   188â†’node = context.diagram.get_node(node_id)\n   189â†’\n   190â†’# Get nodes by type\n   191â†’person_job_nodes = context.diagram.get_nodes_by_type(NodeType.PERSON_JOB)\n   192â†’\n   193â†’# Get incoming edges for a node\n   194â†’incoming = context.diagram.get_incoming_edges(node_id)\n   195â†’\n   196â†’# Get outgoing edges for a node\n   197â†’outgoing = context.diagram.get_outgoing_edges(node_id)\n   198â†’\n   199â†’# Get start nodes\n   200â†’start_nodes = context.diagram.get_start_nodes()\n   201â†’```\n   202â†’\n   203â†’### âŒ DON'T: Direct access to internals\n   204â†’Never directly access diagram internal collections:\n   205â†’\n   206â†’```python\n   207â†’# BAD: Direct access to nodes\n   208â†’for node in diagram.nodes:  # âŒ Don't do this\n   209â†’    if node.type == NodeType.PERSON_JOB:\n   210â†’        ...\n   211â†’\n   212â†’# GOOD: Use query method\n   213â†’for node in diagram.get_nodes_by_type(NodeType.PERSON_JOB):  # âœ… Do this\n   214â†’    ...\n   215â†’\n   216â†’# BAD: Direct access to edges\n   217â†’incoming = [e for e in diagram.edges if e.target_node_id == node_id]  # âŒ\n   218â†’\n   219â†’# GOOD: Use query method\n   220â†’incoming = diagram.get_incoming_edges(node_id)  # âœ…\n   221â†’```\n   222â†’\n   223â†’### Why This Matters\n   224â†’- **Performance**: Query methods use pre-indexed lookups (O(1) instead of O(n))\n   225â†’- **Maintainability**: Internal structure can change without breaking code\n   226â†’- **Type Safety**: Query methods provide consistent interfaces\n   227â†’- **Testing**: Easier to mock query methods than complex diagram structures\n   228â†’\n   229â†’### Enforcement\n   230â†’A pre-commit hook (`check-diagram-access.py`) enforces these patterns in the application layer.\n   231â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"
    max_iteration: 1
- label: User Input 16
  type: person_job
  position: {x: 300, y: 250}
  props:
    person: user
    default_prompt: "     1â†’# Infrastructure Layer\n     2â†’\n     3â†’Concrete implementations of domain ports for all I/O operations.\n     4â†’\n     5â†’## Structure\n     6â†’\n     7â†’| Module | Purpose |\n     8â†’|--------|----------|\n     9â†’| `codegen/` | TypeScript AST parsing, Jinja2 templates |\n    10â†’| `diagram/` | Diagram compilation, storage, conversion |\n    11â†’| `events/` | Event bus (in-memory, Redis) |\n    12â†’| `execution/` | State management, message routing |\n    13â†’| `integrations/` | External APIs (Notion, Slack) |\n    14â†’| `llm/` | LLM providers (unified clients), domain adapters, simplified service |\n    15â†’| `repositories/` | Conversation storage (in-memory, persistent) |\n    16â†’| `shared/` | File system, database, API keys |\n    17â†’\n    18â†’## Key Patterns\n    19â†’\n    20â†’```python\n    21â†’# Port/Adapter - Domain defines interface, infra implements\n    22â†’class LocalBlobAdapter(BlobStorePort):\n    23â†’    async def put(self, key: str, data: bytes) -> str:\n    24â†’        pass\n    25â†’\n    26â†’# Driver - Orchestrates multiple adapters with mixin composition\n    27â†’class DiagramService(LoggingMixin, ValidationMixin, DiagramPort):\n    28â†’    def __init__(self, storage: DiagramStoragePort, converter: DiagramConverterService):\n    29â†’        pass\n    30â†’\n    31â†’# Configuration - Centralized settings\n    32â†’from dipeo.infrastructure.config import get_settings\n    33â†’settings = get_settings()  # Uses DIPEO_* env vars\n    34â†’\n    35â†’# Dependency Injection - Wired through containers\n    36â†’filesystem = request.services.get(\"filesystem_adapter\")\n    37â†’```\n    38â†’\n    39â†’## Components\n    40â†’\n    41â†’### Storage Adapters\n    42â†’| Adapter | Use Case |\n    43â†’|---------|----------|\n    44â†’| `LocalFileSystemAdapter` | Config files, temp files |\n    45â†’| `LocalBlobAdapter` | Versioned storage |\n    46â†’| `S3Adapter` | Cloud deployments |\n    47â†’| `ArtifactStoreAdapter` | ML models, binaries |\n    48â†’\n    49â†’### LLM Adapters (`llm/adapters/`)\n    50â†’- **LLMMemorySelectionAdapter**: Implements MemorySelectionPort using LLM\n    51â†’  - Creates selector facets for intelligent memory selection\n    52â†’  - Filters out selector facet messages from candidates\n    53â†’  - Preserves system messages automatically\n    54â†’  - Supports natural language criteria for selection\n    55â†’  - Features: Message deduplication, scoring, ranking\n    56â†’- **LLMDecisionAdapter**: Binary decision making using LLM\n    57â†’  - Creates decision facets for unbiased evaluation\n    58â†’  - Parses YES/NO responses with keyword detection\n    59â†’  - Supports memory profiles for context control\n    60â†’  - Used by condition nodes for AI-powered flow control\n    61â†’\n    62â†’### Conversation Repositories\n    63â†’- **InMemoryConversationRepository**: Fast, ephemeral storage\n    64â†’- **InMemoryPersonRepository**: Person entity management\n    65â†’- **Features**: Message filtering, person-specific views\n    66â†’\n    67â†’### LLM Infrastructure (Updated 2025-09-10)\n    68â†’- **LLMInfraService**: Main LLM orchestrator\n    69â†’- **Unified Client Architecture**: \n    70â†’  - Core types in `llm/core/types.py` (AdapterConfig, TokenUsage, LLMResponse)\n    71â†’  - All providers use unified clients directly (no adapter/client separation)\n    72â†’  - Each provider has a single `unified_client.py` file\n    73â†’- **Domain Adapters** (`llm/domain_adapters/`):\n    74â†’  - `memory_selection.py`: LLMMemorySelectionAdapter for intelligent memory filtering\n    75â†’  - `decision.py`: LLMDecisionAdapter for binary decision making\n    76â†’- **Provider Unified Clients** (`llm/providers/`): \n    77â†’  - **OpenAI** (`UnifiedOpenAIClient`): Uses new `responses.create()` and `responses.parse()` APIs\n    78â†’    - `input` parameter instead of `messages`\n    79â†’    - `max_output_tokens` instead of `max_tokens`\n    80â†’    - `text_format` for structured output with Pydantic models\n    81â†’    - Temperature not supported in new API\n    82â†’  - **Anthropic** (`UnifiedAnthropicClient`): Claude models with tool use support\n    83â†’  - **Google** (`UnifiedGoogleClient`):\
      \ Gemini models\n    84â†’  - **Ollama** (`UnifiedOllamaClient`): Local model support with auto-pull\n    85â†’  - **Claude Code** (`UnifiedClaudeCodeClient`): Claude Code SDK integration with session pooling\n    86â†’- **Capabilities**: \n    87â†’  - Retry logic with exponential backoff\n    88â†’  - Streaming support (SSE mode)\n    89â†’  - Structured output (JSON schema and Pydantic)\n    90â†’  - Tool/function calling\n    91â†’  - Phase-aware execution\n    92â†’  - Batch processing support (provider-specific)\n    93â†’\n    94â†’### Messaging (v1.0 Unified)\n    95â†’- **MessageRouter**: Central event distribution\n    96â†’- **Flow**: Engine â†’ EventBus â†’ MessageRouter â†’ GraphQL/SSE\n    97â†’- **Unified EventBus**: Single protocol replacing DomainEventBus, EventEmitter, EventConsumer, MessageBus\n    98â†’\n    99â†’### Code Generation\n   100â†’- **parsers/**: TypeScript AST parsing\n   101â†’- **templates/**: Jinja2 with custom filters\n   102â†’\n   103â†’## Environment Variables\n   104â†’\n   105â†’```bash\n   106â†’DIPEO_BASE_DIR=/path/to/project    # Project root\n   107â†’DIPEO_PORT=8000                    # Server port  \n   108â†’DIPEO_DEFAULT_LLM_MODEL=gpt-5-nano-2025-08-07  # Default LLM\n   109â†’DIPEO_LLM_TIMEOUT=300               # LLM timeout (seconds)\n   110â†’DIPEO_EXECUTION_TIMEOUT=3600       # Max execution time\n   111â†’DIPEO_PARALLEL_EXECUTION=true      # Enable parallel\n   112â†’```\n   113â†’\n   114â†’## Component Lifecycle (v1.0 Mixin-based)\n   115â†’\n   116â†’```python\n   117â†’# 1. Create via DI container with mixin composition\n   118â†’service = DiagramService(storage, converter)  # Inherits LoggingMixin, ValidationMixin\n   119â†’# 2. Initialize (mixin methods available)\n   120â†’await service.initialize()\n   121â†’# 3. Use with mixin capabilities\n   122â†’diagram = await service.load_from_file(\"diagram.json\")  # Auto-logging, validation\n   123â†’# 4. Cleanup\n   124â†’await service.cleanup()\n   125â†’```\n   126â†’\n   127â†’## Error Handling\n   128â†’\n   129â†’```python\n   130â†’try:\n   131â†’    result = await adapter.operation()\n   132â†’except Exception as e:\n   133â†’    raise StorageError(f\"Operation failed: {e}\")\n   134â†’```\n   135â†’\n   136â†’## Best Practices\n   137â†’\n   138â†’1. **Use Ports**: Import from `dipeo.domain.ports`, not concrete adapters\n   139â†’2. **Handle Retries**: Implement exponential backoff in adapters\n   140â†’3. **Async I/O**: All I/O operations should be async\n   141â†’4. **Centralize Config**: Use `get_settings()` for all configuration\n   142â†’5. **Log Operations**: Debug-level for normal ops, error for failures\n   143â†’\n   144â†’## Adding New Infrastructure\n   145â†’\n   146â†’### Storage Adapter\n   147â†’1. Implement port: `class RedisAdapter(BlobStorePort)`\n   148â†’2. Register in DI container\n   149â†’3. Wire to services\n   150â†’\n   151â†’### LLM-based Adapter\n   152â†’1. Create adapter in `llm/adapters/`: `class CustomLLMAdapter`\n   153â†’2. Use orchestrator for person/facet management\n   154â†’3. Wire to appropriate handlers or evaluators\n   155â†’\n   156â†’### Conversation Repository\n   157â†’1. Implement repository interface\n   158â†’2. Create adapter: `class RedisConversationRepository`\n   159â†’3. Register in DI container\n   160â†’\n   161â†’### LLM Provider  \n   162â†’1. Create unified client: `class UnifiedMistralClient` in `providers/mistral/unified_client.py`\n   163â†’2. Implement required methods: `async_chat()`, `stream()`, `batch_chat()`\n   164â†’3. Update factory in `llm/drivers/factory.py` to return the unified client\n   165â†’4. Export from `providers/mistral/__init__.py`\n   166â†’\n   167â†’#### OpenAI API Migration Notes (2025)\n   168â†’- The OpenAI SDK migrated from `chat.completions.create()` to `responses.create()`\n   169â†’- Key changes:\n   170â†’  - `messages` â†’ `input`\n   171â†’  - `max_tokens` â†’ `max_output_tokens`\n   172â†’  - Temperature parameter removed\n   173â†’  - Structured output: `parse()` for Pydantic, `create()` for JSON schema\n   174â†’- Response structure: `response.output[0].content[0].text`\n   175â†’- TokenUsage compatibility: Added `total` property mapping to `total_tokens`\n   176â†’\n   177â†’### External API\n   178â†’1.\
      \ Create provider: `class JiraProvider(BaseProvider)`\n   179â†’2. Register in integrated API service\n   180â†’\n   181â†’## Common Issues\n   182â†’\n   183â†’| Issue | Solution |\n   184â†’|-------|----------|\n   185â†’| Adapter not initialized | Ensure `await service.initialize()` called |\n   186â†’| Connection timeout | Increase `DIPEO_API_TIMEOUT` |\n   187â†’| File not found | Check `DIPEO_BASE_DIR` and paths |\n   188â†’| Rate limit exceeded | Adjust `DIPEO_LLM_MAX_RETRIES` |\n   189â†’| OpenAI temperature error | Temperature not supported in new `responses` API |\n   190â†’| OpenAI parameter error | Use `max_output_tokens` not `max_tokens` |\n   191â†’| TokenUsage missing 'total' | Use `total_tokens` or compatibility property |\n   192â†’\n   193â†’## v1.1 Architecture Changes (2025-09-10)\n   194â†’\n   195â†’### LLM Provider Simplification (Phase 3B)\n   196â†’- **Unified Clients**: All providers now use single unified client per provider\n   197â†’- **Removed Layers**: Eliminated adapter.py, client.py, adapter_wrapper.py files\n   198â†’- **Direct Factory Returns**: Factory returns unified clients directly, no adapter wrapping\n   199â†’- **Benefits**:\n   200â†’  - 50% less code in provider directories\n   201â†’  - Single source of truth per provider\n   202â†’  - Easier to add new providers\n   203â†’  - Clearer separation between domain logic and provider logic\n   204â†’\n   205â†’## v1.0 Architecture Changes (2025-09-05)\n   206â†’\n   207â†’### Service Architecture\n   208â†’- **BaseService Removal**: Services now use optional mixin composition instead of base class inheritance\n   209â†’- **Available Mixins**: LoggingMixin, ValidationMixin, ConfigurationMixin, CachingMixin, InitializationMixin\n   210â†’- **Flexible Composition**: Services implement only needed capabilities\n   211â†’\n   212â†’### Event System\n   213â†’- **Unified EventBus**: Single protocol replacing DomainEventBus, EventEmitter, EventConsumer, MessageBus\n   214â†’- **Simplified Flow**: Engine â†’ EventBus â†’ MessageRouter â†’ GraphQL/SSE\n   215â†’- **No Adapter Layer**: CacheFirstStateStore implements StateRepository protocol directly\n   216â†’\n   217â†’### Repository Simplification\n   218â†’- **StateRepositoryAdapter Removed**: CacheFirstStateStore now implements protocol directly\n   219â†’- **Cleaner Architecture**: Fewer abstraction layers, direct protocol implementation\n   220â†’\n   221â†’## Performance & Security\n   222â†’\n   223â†’### Performance\n   224â†’- **Connection Pooling**: LLM adapters cache for 1 hour\n   225â†’- **Async I/O**: Use `asyncio.gather()` for parallel ops\n   226â†’- **Bounded Queues**: SSE uses `Queue(maxsize=100)` for backpressure\n   227â†’\n   228â†’### Security\n   229â†’- Never log API keys\n   230â†’- Validate file paths and extensions\n   231â†’- Set timeouts and size limits\n   232â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"
    max_iteration: 1
- label: User Input 17
  type: person_job
  position: {x: 350, y: 250}
  props:
    person: user
    default_prompt: "     1â†’# Domain Layer\n     2â†’\n     3â†’Pure business logic following DDD and hexagonal architecture.\n     4â†’\n     5â†’## Principles\n     6â†’- **No dependencies** on infrastructure/application layers\n     7â†’- **Port interfaces** (protocols) for infrastructure to implement\n     8â†’- **Rich domain models** with behavior, not just data\n     9â†’\n    10â†’## Bounded Contexts\n    11â†’\n    12â†’### 1. Conversation (`conversation/`)\n    13â†’- **Person**: Agent with Brain (memory selection) and Hand (execution) components\n    14â†’- **CognitiveBrain**: Memory selection, scoring, and deduplication logic\n    15â†’  - MessageScorer: Scores messages by recency, frequency, relevance\n    16â†’  - MessageDeduplicator: Removes duplicate messages based on content overlap\n    17â†’  - MemorySelectionConfig: Configuration for memory selection behavior\n    18â†’- **Conversation**: Dialogue history management\n    19â†’- **Ports**: MemorySelectionPort protocol for LLM-based selection\n    20â†’\n    21â†’### 2. Diagram (`diagram/`)\n    22â†’- **Compilation**: DomainCompiler, NodeFactory, ConnectionResolver, CompileTimeResolver\n    23â†’- **Strategies**: Native, Readable, Light, Executable formats\n    24â†’- **Models**: ExecutableDiagram, ExecutableNode/Edge\n    25â†’- **Claude Code Translation** (`cc_translate/`): Converts Claude Code sessions to DiPeO diagrams\n    26â†’  - `translator.py`: Main orchestration logic\n    27â†’  - `node_builders.py`: Node creation for different tool types\n    28â†’  - `text_utils.py`: Text extraction and unescaping\n    29â†’  - `diff_utils.py`: Unified diff generation for Edit operations\n    30â†’- **Services**: DiagramFormatDetector, DiagramStatisticsService\n    31â†’\n    32â†’### 3. Execution (`execution/`)\n    33â†’- **Resolution**: RuntimeInputResolver, TransformationEngine, NodeStrategies\n    34â†’- ConnectionRules, TransformRules  \n    35â†’- DynamicOrderCalculator\n    36â†’\n    37â†’### 4. Events (`events/`)\n    38â†’- Event contracts and messaging patterns\n    39â†’\n    40â†’### 5. Integrations (`integrations/`)\n    41â†’- **API**: APIBusinessLogic, RetryPolicy\n    42â†’- **Database**: DBOperationsDomainService\n    43â†’- **File**: FileExtension, FileSize, Checksum\n    44â†’- **Validators**: API, Data, File, Notion\n    45â†’\n    46â†’### 6. Base (`base/`)\n    47â†’- BaseValidator, exceptions, service base classes\n    48â†’\n    49â†’## Key Patterns\n    50â†’\n    51â†’```python\n    52â†’# Value Objects - Immutable, self-validating\n    53â†’@dataclass(frozen=True)\n    54â†’class RetryPolicy:\n    55â†’    max_attempts: int = 3\n    56â†’    initial_delay: float = 1.0\n    57â†’\n    58â†’# Domain Services - Stateless business logic\n    59â†’class DiagramStatisticsService:\n    60â†’    def calculate_complexity(self, diagram: DomainDiagram) -> ComplexityMetrics:\n    61â†’        pass\n    62â†’\n    63â†’# Cognitive Components - Memory and reasoning\n    64â†’class CognitiveBrain:\n    65â†’    def __init__(self, memory_selector: MemorySelectionPort):\n    66â†’        self._memory_selector = memory_selector\n    67â†’        self._scorer = MessageScorer()\n    68â†’        self._deduplicator = MessageDeduplicator()\n    69â†’    \n    70â†’    async def select_memories(self, messages, criteria, at_most):\n    71â†’        # Intelligent memory selection with scoring and filtering\n    72â†’\n    73â†’# Strategies - Pluggable algorithms\n    74â†’class BaseConversionStrategy(FormatStrategy, ABC):\n    75â†’    @abstractmethod\n    76â†’    def extract_nodes(self, data: dict) -> list[dict]:\n    77â†’        pass\n    78â†’\n    79â†’# Validators - Rules with warnings/errors\n    80â†’class DiagramValidator(BaseValidator):\n    81â†’    def _perform_validation(self, diagram, result):\n    82â†’        pass\n    83â†’\n    84â†’# Ports - Domain interfaces\n    85â†’class MemorySelectionPort(Protocol):\n    86â†’    async def select_memories(\n    87â†’        self, person_id: PersonID, candidate_messages: Sequence[Message],\n    88â†’        task_preview: str, criteria: str, at_most: Optional[int]\n    89â†’    ) -> list[str]:\n    90â†’        ...\n    91â†’```\n    92â†’\n    93â†’\n    94â†’## Usage Guidelines\n\
      \    95â†’\n    96â†’### Adding Business Logic\n    97â†’1. Choose: value object, entity, or service\n    98â†’2. Place in appropriate bounded context\n    99â†’3. Write pure unit tests\n   100â†’4. Define ports for I/O\n   101â†’\n   102â†’### Module Organization for Large Services\n   103â†’When a domain service grows beyond ~400 lines, consider refactoring into a module:\n   104â†’```\n   105â†’domain/context/service_module/\n   106â†’â”œâ”€â”€ __init__.py         # Export main service class\n   107â†’â”œâ”€â”€ service.py          # Main orchestration logic (~150-200 lines)\n   108â†’â”œâ”€â”€ builders.py         # Factory/builder methods\n   109â†’â”œâ”€â”€ utils.py            # Utility functions\n   110â†’â””â”€â”€ specialized.py      # Specialized logic\n   111â†’```\n   112â†’Example: `cc_translate/` module for Claude Code translation\n   113â†’\n   114â†’### Extending Validators\n   115â†’```python\n   116â†’class MyValidator(BaseValidator):\n   117â†’    def _perform_validation(self, target, result):\n   118â†’        if not self._check_rule(target):\n   119â†’            result.add_error(ValidationError(\"Rule violated\"))\n   120â†’```\n   121â†’\n   122â†’### Adding Diagram Formats\n   123â†’1. Extend `BaseConversionStrategy`\n   124â†’2. Register in `DiagramFormatDetector`\n   125â†’3. Implement node/arrow extraction\n   126â†’\n   127â†’\n   128â†’## Testing\n   129â†’\n   130â†’- **Unit tests only** - pure functions, no I/O\n   131â†’- **No mocks** - in-memory operations\n   132â†’- **Fast** - milliseconds per test\n   133â†’\n   134â†’```python\n   135â†’def test_connection_rules():\n   136â†’    assert NodeConnectionRules.can_connect(NodeType.START, NodeType.PERSON_JOB)\n   137â†’    assert not NodeConnectionRules.can_connect(NodeType.ENDPOINT, NodeType.START)\n   138â†’```\n   139â†’\n   140â†’## Import Paths\n   141â†’\n   142â†’```python\n   143â†’# Current imports (v1.0 unified)\n   144â†’from dipeo.domain.diagram.compilation import CompileTimeResolver, Connection, TransformRules\n   145â†’from dipeo.domain.diagram.cc_translate import ClaudeCodeTranslator  # Claude Code session translation\n   146â†’from dipeo.domain.execution.resolution import RuntimeInputResolver, TransformationEngine\n   147â†’from dipeo.domain.execution.envelope import EnvelopeFactory  # Unified output pattern\n   148â†’from dipeo.domain.events import EventBus  # Unified event protocol\n   149â†’from dipeo.domain.ports.storage import StoragePort\n   150â†’from dipeo.domain.integrations.api_services import APIBusinessLogic\n   151â†’from dipeo.domain.conversation import Person\n   152â†’from dipeo.domain.conversation.brain import CognitiveBrain, MemorySelectionConfig\n   153â†’from dipeo.domain.conversation.ports import MemorySelectionPort\n   154â†’```\n   155â†’\n   156â†’## Envelope Pattern Usage\n   157â†’\n   158â†’The unified envelope pattern uses `EnvelopeFactory.create()` for all envelope creation:\n   159â†’\n   160â†’```python\n   161â†’from dipeo.domain.execution.envelope import EnvelopeFactory\n   162â†’from dipeo.diagram_generated.enums import ContentType  # For explicit content types\n   163â†’\n   164â†’# Basic envelope creation (auto-detects content type)\n   165â†’envelope = EnvelopeFactory.create(\"Hello world\")  # Creates RAW_TEXT\n   166â†’envelope = EnvelopeFactory.create({\"key\": \"value\"})  # Creates OBJECT\n   167â†’envelope = EnvelopeFactory.create(b\"binary data\")  # Creates BINARY\n   168â†’\n   169â†’# Explicit content type specification\n   170â†’envelope = EnvelopeFactory.create(\n   171â†’    body=\"some text\",\n   172â†’    content_type=ContentType.RAW_TEXT,\n   173â†’    produced_by=\"my_node\"\n   174â†’)\n   175â†’\n   176â†’# Error envelopes\n   177â†’envelope = EnvelopeFactory.create(\n   178â†’    body=\"Something went wrong\", \n   179â†’    error=\"ValidationError\",\n   180â†’    produced_by=\"validator_node\"\n   181â†’)\n   182â†’\n   183â†’# With additional metadata\n   184â†’envelope = EnvelopeFactory.create(\n   185â†’    body={\"result\": \"success\"},\n   186â†’    meta={\"timestamp\": time.time(), \"custom_field\": \"value\"}\n   187â†’)\n   188â†’```\n   189â†’\n   190â†’### Deprecated Methods (v1.0)\n   191â†’\n   192â†’The following methods are deprecated and will be removed. Use `EnvelopeFactory.create()`\
      \ instead:\n   193â†’\n   194â†’```python\n   195â†’# DEPRECATED - Use EnvelopeFactory.create() instead\n   196â†’EnvelopeFactory.text(\"content\")           # â†’ EnvelopeFactory.create(\"content\")\n   197â†’EnvelopeFactory.json(data)               # â†’ EnvelopeFactory.create(data)\n   198â†’EnvelopeFactory.binary(bytes_data)       # â†’ EnvelopeFactory.create(bytes_data)\n   199â†’EnvelopeFactory.error(\"msg\", \"ErrorType\") # â†’ EnvelopeFactory.create(\"msg\", error=\"ErrorType\")\n   200â†’EnvelopeFactory.conversation(state)     # â†’ EnvelopeFactory.create(state, content_type=ContentType.CONVERSATION_STATE)\n   201â†’```\n   202â†’\n   203â†’## v1.0 Domain Changes (2025-09-05)\n   204â†’\n   205â†’### Unified Patterns\n   206â†’- **EventBus Protocol**: Single unified interface for all event handling (replaces DomainEventBus, EventEmitter, etc.)\n   207â†’- **Envelope Pattern**: Complete migration from NodeOutput to Envelope for all handler outputs\n   208â†’  - New `EnvelopeFactory.create()` method with auto-detection and unified interface\n   209â†’  - Deprecated specific factory methods (`text()`, `json()`, `error()`, etc.)\n   210â†’  - Consistent error handling through the `error` parameter\n   211â†’- **Protocol Consistency**: Direct protocol implementation without unnecessary adapter layers\n   212â†’\n   213â†’### Naming Conventions\n   214â†’- **Python Internal**: snake_case for all generated Python code\n   215â†’- **JSON/GraphQL Compatibility**: Pydantic Field(alias=...) provides camelCase for external APIs\n   216â†’- **Type Safety**: Maintained across all transformations\n   217â†’\n   218â†’## Dependencies\n   219â†’\n   220â†’- Python standard library\n   221â†’- `dipeo.models` - Generated domain models\n   222â†’- **No framework dependencies** (no FastAPI, SQLAlchemy, etc.)\n   223â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"
    max_iteration: 1
- label: User Input 18
  type: person_job
  position: {x: 400, y: 250}
  props:
    person: user
    default_prompt: |2
           1â†’# DiPeO Models Package
           2â†’
           3â†’TypeScript library serving as the single source of truth for all domain models.
           4â†’
           5â†’## Architecture
           6â†’
           7â†’`TypeScript Sources â†’ AST Parser â†’ Code Generators â†’ Python/GraphQL/Frontend Code`
           8â†’
           9â†’## Structure
          10â†’
          11â†’```
          12â†’src/
          13â†’â”œâ”€â”€ nodes/              # Node specifications (first-class citizens)
          14â†’â”‚   â”œâ”€â”€ *.spec.ts      # 14 node specification files
          15â†’â”‚   â””â”€â”€ index.ts       # Node spec exports
          16â†’â”œâ”€â”€ node-specification.ts  # Node spec types & interfaces
          17â†’â”œâ”€â”€ node-categories.ts     # Node categorization
          18â†’â”œâ”€â”€ node-registry.ts       # Central node registry
          19â†’â”œâ”€â”€ core/               # Domain models, enums
          20â†’â”œâ”€â”€ frontend/           # Query specifications
          21â†’â”œâ”€â”€ codegen/            # AST types, mappings
          22â†’â””â”€â”€ utilities/          # Type conversions
          23â†’```
          24â†’
          25â†’## Key Components
          26â†’
          27â†’### Node Specifications (`nodes/`)
          28â†’- **Primary source of truth** for all node types
          29â†’- 14 node specifications: start, api-job, code-job, condition, db, endpoint, hook, integrated-api, json-schema-validator, person-job, sub-diagram, template-job, typescript-ast, user-response
          30â†’- Each spec defines metadata, fields, UI config, validation rules, and behavior
          31â†’
          32â†’### Core Models (`core/`)
          33â†’- **Diagram**: DomainNode, DomainArrow, DomainHandle, DomainDiagram
          34â†’- **Execution**: ExecutionState, ExecutionContext
          35â†’- **Enums**: NodeType, ExecutionStatus, LLMService, MemoryView, etc.
          36â†’
          37â†’### Frontend (`frontend/`)
          38â†’- GraphQL query specifications
          39â†’- CRUD, relationships, subscriptions
          40â†’
          41â†’### Code Generation (`codegen/`)
          42â†’- AST types, mappings, node-interface map
          43â†’
          44â†’## Code Generation Pipeline
          45â†’
          46â†’1. **Parse**: TypeScript AST extraction
          47â†’2. **Cache**: Results to `.temp/ast_cache/`
          48â†’3. **Generate** (parallel):
          49â†’   - Python models â†’ `dipeo/diagram_generated/domain_models.py`
          50â†’   - GraphQL schema â†’ `dipeo/diagram_generated/domain-schema.graphql`
          51â†’   - Frontend configs â†’ `apps/web/src/__generated__/`
          52â†’
          53â†’## Type System
          54â†’
          55â†’```typescript
          56â†’// Branded types for compile-time safety
          57â†’export type NodeID = string & { readonly __brand: 'NodeID' };
          58â†’
          59â†’// Union types for flexibility
          60â†’export type DataType = 'any' | 'string' | 'number' | 'boolean' | 'object' | 'array';
          61â†’
          62â†’// Nested configurations
          63â†’export interface MemorySettings {
          64â†’  view: MemoryView;
          65â†’  max_messages?: number;
          66â†’}
          67â†’```
          68â†’
          69â†’## Integration
          70â†’
          71â†’- **Frontend**: Direct TypeScript import via `@dipeo/models`
          72â†’- **Backend**: Generated Pydantic models
          73â†’- **GraphQL**: Generated schema
          74â†’- **Validation**: Generated Zod schemas
          75â†’
          76â†’## Workflow
          77â†’
          78â†’### Adding a New Node Type
          79â†’1. Create spec file in `src/nodes/[node-name].spec.ts`
          80â†’2. Export from `src/nodes/index.ts`
          81â†’3. Add to registry in `src/node-registry.ts`
          82â†’4. Build: `cd dipeo/models && pnpm build`
          83â†’5. Generate: `make codegen`
          84â†’6. Changes propagate to Python models, GraphQL schema, and frontend
          85â†’
          86â†’### Modifying Existing Nodes
          87â†’1. Edit spec file in `src/nodes/`
          88â†’2. Build: `cd dipeo/models && pnpm build`
          89â†’3. Generate: `make codegen`
          90â†’4. Changes propagate to all consumers
          91â†’
          92â†’## Benefits
          93â†’
          94â†’- **Single Source of Truth**: Node specifications drive all code generation
          95â†’- **First-Class Node Specs**: Clear, top-level organization emphasizes nodes as core concept
          96â†’- **Type Safety**: Across TypeScript, Python, and GraphQL
          97â†’- **Automated Sync**: Changes propagate automatically to all consumers
          98â†’- **Zero Boilerplate**: Code generation handles duplication
          99â†’- **Clear Architecture**: Flat structure makes node specs immediately discoverable
         100â†’

      <system-reminder>
      Whenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.
      </system-reminder>
    max_iteration: 1
- label: ExitPlanMode 19
  type: api_job
  position: {x: 450, y: 250}
  props:
    endpoint: /tools/ExitPlanMode
    method: POST
    body:
      plan: |-
        ## CLAUDE.md Cleanup Plan

        ### 1. Main CLAUDE.md (`/home/soryhyun/DiPeO/CLAUDE.md`)
        - Remove "ğŸ‰ Implementation Status: COMPLETE" section (lines 121-128)
        - Clean up LLM Infrastructure section - remove "(Updated 2025)" and migration notes
        - Remove "v1.0 Refactoring Complete" from Important Notes
        - Simplify OpenAI migration content to just current usage

        ### 2. Infrastructure CLAUDE.md (`/dipeo/infrastructure/CLAUDE.md`)
        - Remove v1.1 Architecture Changes section (lines 193-203)
        - Remove v1.0 Architecture Changes section (lines 205-220)
        - Clean up OpenAI API Migration Notes - just document current API usage
        - Remove "(Updated 2025-09-10)" markers

        ### 3. Domain CLAUDE.md (`/dipeo/domain/CLAUDE.md`)
        - Remove Deprecated Methods section (lines 190-201)
        - Remove v1.0 Domain Changes section (lines 203-217)
        - Clean up "(Updated 2025-09-05)" markers

        ### 4. General Principles
        - Focus on **what is** rather than **what was done**
        - Remove celebration messages and completion status
        - Remove migration guides for completed migrations
        - Keep only current API usage, not historical changes
        - Remove version markers and update dates

        This will make the documentation cleaner, more focused on current usage, and easier to maintain.
    timeout: 30
- label: Update TODO 20
  type: db
  position: {x: 500, y: 400}
  props:
    operation: write
    sub_type: memory
    query: UPDATE TODO LIST
    data:
      todos:
      - content: Clean up main CLAUDE.md file
        status: pending
        activeForm: Cleaning up main CLAUDE.md file
      - content: Clean up infrastructure CLAUDE.md
        status: pending
        activeForm: Cleaning up infrastructure CLAUDE.md
      - content: Clean up domain CLAUDE.md
        status: pending
        activeForm: Cleaning up domain CLAUDE.md
- label: Update TODO 21
  type: db
  position: {x: 550, y: 400}
  props:
    operation: write
    sub_type: memory
    query: UPDATE TODO LIST
    data:
      todos:
      - content: Clean up main CLAUDE.md file
        status: in_progress
        activeForm: Cleaning up main CLAUDE.md file
      - content: Clean up infrastructure CLAUDE.md
        status: pending
        activeForm: Cleaning up infrastructure CLAUDE.md
      - content: Clean up domain CLAUDE.md
        status: pending
        activeForm: Cleaning up domain CLAUDE.md
- label: MultiEdit File 22
  type: diff_patch
  position: {x: 600, y: 400}
  props:
    target_path: /home/soryhyun/DiPeO/CLAUDE.md
    diff: |
      {'oldStart': 118, 'oldLines': 15, 'newStart': 118, 'newLines': 6, 'lines': [' ', ' ## GraphQL Operations System', ' ', '-### ğŸ‰ Implementation Status: COMPLETE', '-The GraphQL refactoring is **substantially complete** with a solid, production-ready architecture:', '-- âœ… **45 complete operations** with full GraphQL query strings as constants', '-- âœ… **Type-safe operation classes** with proper TypedDict for variables', '-- âœ… **Well-structured resolvers** following consistent patterns', '-- âœ… **Clean 3-tier architecture** separating concerns', '-- âœ… **ServiceRegistry integration** for dependency injection', '-- âœ… **No major refactoring needed** - architecture is solid and maintainable', '-', ' ### Architecture Overview (3-Tier System)', ' 1. **Generated Layer** (`/dipeo/diagram_generated/graphql/`)', '    - `operations.py` - All 45 operations with full support']}
      {'oldStart': 276, 'oldLines': 13, 'newStart': 267, 'newLines': 12, 'lines': [' - `/projects/frontend_auto/` - AI frontend generation ([Frontend Auto](projects/frontend_auto/README.md))', ' - `/projects/frontend_enhance/` - Advanced frontend generation ([Frontend Enhance](docs/projects/frontend-enhance-guide.md))', ' ', '-### LLM Infrastructure (Updated 2025)', '-- **Unified Client Architecture**: All providers use unified clients directly (no adapter/client separation)', '-- **OpenAI API v2 Migration**:', '-  - Uses new `responses.create()` and `responses.parse()` APIs', '-  - `messages` â†’ `input` parameter', '-  - `max_tokens` â†’ `max_output_tokens`', '-  - Temperature parameter no longer supported', '+### LLM Infrastructure', '+- **Unified Client Architecture**: All providers use unified clients directly', '+- **OpenAI API v2**:', '+  - Uses `responses.create()` and `responses.parse()` APIs', '+  - `input` parameter for messages', '+  - `max_output_tokens` for token limits', '   - Response structure: `response.output[0].content[0].text`', ' - **Domain Adapters**:', '   - `LLMMemorySelectionAdapter`: Intelligent memory filtering and selection']}
      {'oldStart': 415, 'oldLines': 7, 'newStart': 405, 'newLines': 7, 'lines': [' - Use **uv** for Python, **pnpm** for JavaScript (not npm/yarn)', ' - Default LLM: `gpt-5-nano-2025-08-07`', ' - Backend port: 8000, Frontend port: 3000', '-- **v1.0 Refactoring Complete**: Services use mixin composition, unified EventBus, complete Envelope migration', '+- **Service Architecture**: Services use mixin composition with unified EventBus and Envelope pattern', ' - **Enhanced Service Registry**: Production-ready dependency injection with type categorization, audit trails, and safety features', ' ', ' ## Common Issues & Solutions']}
      {'oldStart': 427, 'oldLines': 9, 'newStart': 417, 'newLines': 7, 'lines': [' | Generated code out of sync | Run codegen workflow (see above) | [Codegen Guide](docs/projects/code-generation-guide.md) |', ' | TypeScript errors | `make graphql-schema` | |', ' | Need debugging | Add `--debug` flag, check `.logs/` | |', '-| OpenAI temperature error | Temperature not supported in new API, remove parameter | |', '-| OpenAI max_tokens error | Use `max_output_tokens` instead of `max_tokens` | |', "-| TokenUsage missing 'total' | Use `total_tokens` property instead | |", '+| OpenAI API usage | Use `input` parameter and `max_output_tokens` | |', ' | Claude Code sessions | Use `dipeocc` to convert sessions | [DiPeOCC Guide](docs/projects/dipeocc-guide.md) |', ' ', ' ## Testing & Debugging']}
    format: unified
    backup: true
    validate: true
    _original_file_hash: 5729421780742233835
- label: Update TODO 23
  type: db
  position: {x: 650, y: 400}
  props:
    operation: write
    sub_type: memory
    query: UPDATE TODO LIST
    data:
      todos:
      - content: Clean up main CLAUDE.md file
        status: completed
        activeForm: Cleaning up main CLAUDE.md file
      - content: Clean up infrastructure CLAUDE.md
        status: in_progress
        activeForm: Cleaning up infrastructure CLAUDE.md
      - content: Clean up domain CLAUDE.md
        status: pending
        activeForm: Cleaning up domain CLAUDE.md
- label: MultiEdit File 24
  type: diff_patch
  position: {x: 700, y: 400}
  props:
    target_path: /home/soryhyun/DiPeO/dipeo/infrastructure/CLAUDE.md
    diff: |
      {'oldStart': 64, 'oldLines': 7, 'newStart': 64, 'newLines': 7, 'lines': [' - **InMemoryPersonRepository**: Person entity management', ' - **Features**: Message filtering, person-specific views', ' ', '-### LLM Infrastructure (Updated 2025-09-10)', '+### LLM Infrastructure', ' - **LLMInfraService**: Main LLM orchestrator', ' - **Unified Client Architecture**: ', '   - Core types in `llm/core/types.py` (AdapterConfig, TokenUsage, LLMResponse)']}
      {'oldStart': 111, 'oldLines': 7, 'newStart': 111, 'newLines': 7, 'lines': [' DIPEO_PARALLEL_EXECUTION=true      # Enable parallel', ' ```', ' ', '-## Component Lifecycle (v1.0 Mixin-based)', '+## Component Lifecycle', ' ', ' ```python', ' # 1. Create via DI container with mixin composition']}
      {'oldStart': 164, 'oldLines': 15, 'newStart': 164, 'newLines': 13, 'lines': [' 3. Update factory in `llm/drivers/factory.py` to return the unified client', ' 4. Export from `providers/mistral/__init__.py`', ' ', '-#### OpenAI API Migration Notes (2025)', '-- The OpenAI SDK migrated from `chat.completions.create()` to `responses.create()`', '-- Key changes:', '-  - `messages` â†’ `input`', '-  - `max_tokens` â†’ `max_output_tokens`', '-  - Temperature parameter removed', '+#### OpenAI API Usage', '+- Uses `responses.create()` for chat completions', '+- Parameters:', '+  - `input` for messages', '+  - `max_output_tokens` for token limits', '   - Structured output: `parse()` for Pydantic, `create()` for JSON schema', ' - Response structure: `response.output[0].content[0].text`', '-- TokenUsage compatibility: Added `total` property mapping to `total_tokens`', ' ', ' ### External API', ' 1. Create provider: `class JiraProvider(BaseProvider)`']}
      {'oldStart': 186, 'oldLines': 38, 'newStart': 184, 'newLines': 8, 'lines': [' | Connection timeout | Increase `DIPEO_API_TIMEOUT` |', ' | File not found | Check `DIPEO_BASE_DIR` and paths |', ' | Rate limit exceeded | Adjust `DIPEO_LLM_MAX_RETRIES` |', '-| OpenAI temperature error | Temperature not supported in new `responses` API |', '-| OpenAI parameter error | Use `max_output_tokens` not `max_tokens` |', "-| TokenUsage missing 'total' | Use `total_tokens` or compatibility property |", '+| OpenAI API usage | Use `input` and `max_output_tokens` parameters |', ' ', '-## v1.1 Architecture Changes (2025-09-10)', '-', '-### LLM Provider Simplification (Phase 3B)', '-- **Unified Clients**: All providers now use single unified client per provider', '-- **Removed Layers**: Eliminated adapter.py, client.py, adapter_wrapper.py files', '-- **Direct Factory Returns**: Factory returns unified clients directly, no adapter wrapping', '-- **Benefits**:', '-  - 50% less code in provider directories', '-  - Single source of truth per provider', '-  - Easier to add new providers', '-  - Clearer separation between domain logic and provider logic', '-', '-## v1.0 Architecture Changes (2025-09-05)', '-', '-### Service Architecture', '-- **BaseService Removal**: Services now use optional mixin composition instead of base class inheritance', '-- **Available Mixins**: LoggingMixin, ValidationMixin, ConfigurationMixin, CachingMixin, InitializationMixin', '-- **Flexible Composition**: Services implement only needed capabilities', '-', '-### Event System', '-- **Unified EventBus**: Single protocol replacing DomainEventBus, EventEmitter, EventConsumer, MessageBus', '-- **Simplified Flow**: Engine â†’ EventBus â†’ MessageRouter â†’ GraphQL/SSE', '-- **No Adapter Layer**: CacheFirstStateStore implements StateRepository protocol directly', '-', '-### Repository Simplification', '-- **StateRepositoryAdapter Removed**: CacheFirstStateStore now implements protocol directly', '-- **Cleaner Architecture**: Fewer abstraction layers, direct protocol implementation', '-', ' ## Performance & Security', ' ', ' ### Performance']}
    format: unified
    backup: true
    validate: true
    _original_file_hash: 8890362461206830271
- label: Update TODO 25
  type: db
  position: {x: 750, y: 400}
  props:
    operation: write
    sub_type: memory
    query: UPDATE TODO LIST
    data:
      todos:
      - content: Clean up main CLAUDE.md file
        status: completed
        activeForm: Cleaning up main CLAUDE.md file
      - content: Clean up infrastructure CLAUDE.md
        status: completed
        activeForm: Cleaning up infrastructure CLAUDE.md
      - content: Clean up domain CLAUDE.md
        status: in_progress
        activeForm: Cleaning up domain CLAUDE.md
- label: MultiEdit File 26
  type: diff_patch
  position: {x: 800, y: 400}
  props:
    target_path: /home/soryhyun/DiPeO/dipeo/domain/CLAUDE.md
    diff: |
      {'oldStart': 187, 'oldLines': 34, 'newStart': 187, 'newLines': 6, 'lines': [' )', ' ```', ' ', '-### Deprecated Methods (v1.0)', '-', '-The following methods are deprecated and will be removed. Use `EnvelopeFactory.create()` instead:', '-', '-```python', '-# DEPRECATED - Use EnvelopeFactory.create() instead', '-EnvelopeFactory.text("content")           # â†’ EnvelopeFactory.create("content")', '-EnvelopeFactory.json(data)               # â†’ EnvelopeFactory.create(data)', '-EnvelopeFactory.binary(bytes_data)       # â†’ EnvelopeFactory.create(bytes_data)', '-EnvelopeFactory.error("msg", "ErrorType") # â†’ EnvelopeFactory.create("msg", error="ErrorType")', '-EnvelopeFactory.conversation(state)     # â†’ EnvelopeFactory.create(state, content_type=ContentType.CONVERSATION_STATE)', '-```', '-', '-## v1.0 Domain Changes (2025-09-05)', '-', '-### Unified Patterns', '-- **EventBus Protocol**: Single unified interface for all event handling (replaces DomainEventBus, EventEmitter, etc.)', '-- **Envelope Pattern**: Complete migration from NodeOutput to Envelope for all handler outputs', '-  - New `EnvelopeFactory.create()` method with auto-detection and unified interface', '-  - Deprecated specific factory methods (`text()`, `json()`, `error()`, etc.)', '-  - Consistent error handling through the `error` parameter', '-- **Protocol Consistency**: Direct protocol implementation without unnecessary adapter layers', '-', '-### Naming Conventions', '-- **Python Internal**: snake_case for all generated Python code', '-- **JSON/GraphQL Compatibility**: Pydantic Field(alias=...) provides camelCase for external APIs', '-- **Type Safety**: Maintained across all transformations', '-', ' ## Dependencies', ' ', ' - Python standard library']}
    format: unified
    backup: true
    validate: true
    _original_file_hash: -7945595564676009843
- label: Update TODO 27
  type: db
  position: {x: 850, y: 400}
  props:
    operation: write
    sub_type: memory
    query: UPDATE TODO LIST
    data:
      todos:
      - content: Clean up main CLAUDE.md file
        status: completed
        activeForm: Cleaning up main CLAUDE.md file
      - content: Clean up infrastructure CLAUDE.md
        status: completed
        activeForm: Cleaning up infrastructure CLAUDE.md
      - content: Clean up domain CLAUDE.md
        status: completed
        activeForm: Cleaning up domain CLAUDE.md
- label: Update TODO 28
  type: db
  position: {x: 900, y: 400}
  props:
    operation: write
    sub_type: memory
    query: UPDATE TODO LIST
    data:
      todos: []
- label: User Input 29
  type: person_job
  position: {x: 950, y: 400}
  props:
    person: user
    default_prompt: Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable
    max_iteration: 1
- label: Claude Response 30
  type: person_job
  position: {x: 1000, y: 550}
  props:
    person: claude_code
    default_prompt: 'Process and respond: '
    max_iteration: 1
- label: Bash Command 31
  type: code_job
  position: {x: 1050, y: 550}
  props:
    language: bash
    code: find /home/soryhyun/DiPeO -type f -name "*handler*.py" | grep -E "handlers?/" | head -20
    timeout: 120000
    description: Find handler files in the project
- label: Bash Command 32
  type: code_job
  position: {x: 300, y: 550}
  props:
    language: bash
    code: ls -la /home/soryhyun/DiPeO/dipeo/application/execution/handlers/
    timeout: 120000
    description: List handler directory structure
- label: Bash Command 33
  type: code_job
  position: {x: 350, y: 550}
  props:
    language: bash
    code: ls -la /home/soryhyun/DiPeO/dipeo/infrastructure/codegen/ir_builders/
    timeout: 120000
    description: Check IR builders directory
- label: Bash Command 34
  type: code_job
  position: {x: 400, y: 550}
  props:
    language: bash
    code: ls -la /home/soryhyun/DiPeO/dipeo/application/execution/handlers/codegen/
    timeout: 120000
    description: Check codegen handlers directory
- label: Grep Search 35
  type: code_job
  position: {x: 450, y: 550}
  props:
    language: bash
    code: rg -l 'class.*JsonSchemaValidator.*NodeHandler' /home/soryhyun/DiPeO/dipeo/application/execution/handlers
    tool: Grep
    description: Grep search operation
- label: Update TODO 36
  type: db
  position: {x: 500, y: 550}
  props:
    operation: write
    sub_type: memory
    query: UPDATE TODO LIST
    data:
      todos:
      - content: Update handler paths in main CLAUDE.md
        status: in_progress
        activeForm: Updating handler paths in main CLAUDE.md
      - content: Add IR builders location to main CLAUDE.md
        status: pending
        activeForm: Adding IR builders location to main CLAUDE.md
- label: Edit File 37
  type: diff_patch
  position: {x: 550, y: 550}
  props:
    target_path: /home/soryhyun/DiPeO/CLAUDE.md
    diff: |
      {'oldStart': 232, 'oldLines': 21, 'newStart': 232, 'newLines': 24, 'lines': [' #### Individual Node Handlers (Direct Files)', ' - `api_job.py` - API call handling', ' - `db.py` - Database operations', '+- `diff_patch.py` - Diff patch operations', ' - `endpoint.py` - HTTP endpoint handling', ' - `hook.py` - Hook/callback handling', ' - `integrated_api.py` - Integrated API operations ([Integration Guide](docs/integrations/claude-code.md))', '-- `json_schema_validator.py` - JSON schema validation', ' - `start.py` - Start node handling', '-- `template_job.py` - Template processing', '-- `typescript_ast.py` - TypeScript AST operations', ' - `user_response.py` - User response handling', ' ', '+#### Codegen Handlers (`codegen/`)', '+- `ir_builder.py` - IR (Intermediate Representation) building', '+- `schema_validator.py` - JSON schema validation', '+- `template.py` - Template processing', '+- `typescript_ast.py` - TypeScript AST operations', '+', ' #### Complex Node Handlers (Subdirectories)', ' - **person_job/** - LLM/AI agent handling', '-  - `batch_executor.py` - Batch person execution', '   - `conversation_handler.py` - Conversation management', '-  - `prompt_resolver.py` - Prompt resolution', '   - `text_format_handler.py` - Text formatting', '+  - Other executors for batch and prompt resolution', ' - **sub_diagram/** - Sub-diagram execution', '   - `lightweight_executor.py` - Light diagram execution', '   - `single_executor.py` - Single sub-diagram execution']}
      {'oldStart': 258, 'oldLines': 6, 'newStart': 261, 'newLines': 15, 'lines': [' - **condition/** - Conditional logic', '   - `evaluators/` - Condition evaluators', ' ', '+### IR Builders - Path Reference', '+**Base Directory**: `/dipeo/infrastructure/codegen/ir_builders/`', '+', '+- `backend.py` - Backend IR builder (consolidates models/types)', '+- `frontend.py` - Frontend IR builder (extracts components/schemas)', '+- `strawberry.py` - GraphQL operations & domain types', '+- `base.py` - Base IR builder interface', '+- `utils.py` - Shared utilities for IR building', '+', ' ### Key Directories', ' - `/apps/server/` - FastAPI backend', ' - `/apps/web/` - React frontend ([Frontend README](apps/web/src/domain/README.md))']}
    format: unified
    backup: true
    validate: true
    _original_file_hash: -5516433807538784690
- label: Read File 38
  type: db
  position: {x: 600, y: 550}
  props:
    operation: read
    sub_type: file
    file: /home/soryhyun/DiPeO/CLAUDE.md
- label: Read File 39
  type: db
  position: {x: 650, y: 550}
  props:
    operation: read
    sub_type: file
    file: /home/soryhyun/DiPeO/CLAUDE.md
- label: Edit File 40
  type: diff_patch
  position: {x: 700, y: 700}
  props:
    target_path: /home/soryhyun/DiPeO/CLAUDE.md
    diff: |
      {'oldStart': 423, 'oldLines': 7, 'newStart': 423, 'newLines': 7, 'lines': [' ## Common Issues & Solutions', ' ', ' | Issue | Solution | Documentation |', '-|---|---|---|', '+|-------|----------|---------------|', ' | Import errors | Run `make install` (uv manages activation automatically) | |', ' | uv not found | `make install` (auto-installs uv) | |', ' | Generated code out of sync | Run codegen workflow (see above) | [Codegen Guide](docs/projects/code-generation-guide.md) |']}
    format: unified
    backup: true
    validate: true
    _original_file_hash: -3052329882745433380
- label: Update TODO 41
  type: db
  position: {x: 750, y: 700}
  props:
    operation: write
    sub_type: memory
    query: UPDATE TODO LIST
    data:
      todos:
      - content: Update handler paths in main CLAUDE.md
        status: completed
        activeForm: Updating handler paths in main CLAUDE.md
      - content: Add IR builders location to main CLAUDE.md
        status: completed
        activeForm: Adding IR builders location to main CLAUDE.md
- label: Update TODO 42
  type: db
  position: {x: 800, y: 700}
  props:
    operation: write
    sub_type: memory
    query: UPDATE TODO LIST
    data:
      todos: []
- label: User Input 43
  type: person_job
  position: {x: 850, y: 700}
  props:
    person: user
    default_prompt: Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable
    max_iteration: 1
- label: Claude Response 44
  type: person_job
  position: {x: 900, y: 700}
  props:
    person: claude_code
    default_prompt: 'Process and respond: '
    max_iteration: 1
- label: Read File 45
  type: db
  position: {x: 950, y: 700}
  props:
    operation: read
    sub_type: file
    file: /home/soryhyun/DiPeO/CLAUDE.md
- label: Edit File 46
  type: diff_patch
  position: {x: 1000, y: 700}
  props:
    target_path: /home/soryhyun/DiPeO/CLAUDE.md
    diff: |
      {'oldStart': 94, 'oldLines': 27, 'newStart': 94, 'newLines': 20, 'lines': [' ', ' **âš ï¸ WARNING**: Code generation overwrites ALL generated code in `dipeo/diagram_generated/`!', ' ', '-### Workflow', '+### Workflow & Staging', ' 1. **Modify TypeScript specs** in `/dipeo/models/src/`, then: `cd dipeo/models && pnpm build`', ' 2. **Generate**: `make codegen` (includes parse-typescript automatically)', '+   - Outputs to `dipeo/diagram_generated_staged/` for review', ' 3. **Verify**: `make diff-staged` to review changes', '-4. **Apply**: Choose one:', '-   - `make apply-syntax-only` - Applies staged â†’ active with syntax validation only (fastest, minimal safety)', '-   - `make apply` - Applies staged â†’ active with full type checking (safer but slower)', '-   - `make apply-test` - Applies staged â†’ active after full server validation (strongest safety, ensures server can actually run)', '+4. **Apply** staged â†’ active (`dipeo/diagram_generated/`), choose validation level:', '+   - `make apply-syntax-only` - Syntax validation only (fastest)', '+   - `make apply` - Full type checking (recommended)', '+   - `make apply-test` - Server startup test (safest, includes health checks)', ' 5. **Update GraphQL**: `make graphql-schema`', ' ', '-Quick command: `make codegen-auto` (runs all steps - USE WITH CAUTION)', '+**Quick command**: `make codegen-auto` (runs all steps - USE WITH CAUTION)', ' ', '-### Staging System', '-- **Generated to**: `dipeo/diagram_generated_staged/` (for review - temporary staging area)', '-- **Active code**: `dipeo/diagram_generated/` (in use - DO NOT EDIT DIRECTLY)', '-- **Apply changes**: Three validation levels available:', '-  - `make apply-syntax-only` - Syntax validation only (fastest)', '-  - `make apply` - Full type checking (comprehensive validation)', '-  - `make apply-test` - Complete server startup test with staged code (includes critical imports, server health, GraphQL endpoint testing)', '-- **Why staging**: Safety, validation, easy rollback', '-- **Full docs**: [Code Generation Guide](docs/projects/code-generation-guide.md)', '+**Full docs**: [Code Generation Guide](docs/projects/code-generation-guide.md)', ' ', ' ## GraphQL Operations System', ' ']}
    format: unified
    backup: true
    validate: true
    _original_file_hash: 6395906831752982682
- label: User Input 47
  type: person_job
  position: {x: 1050, y: 700}
  props:
    person: user
    default_prompt: |-
      The file /home/soryhyun/DiPeO/CLAUDE.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
          89â†’dipeo integrations openapi-import spec.yaml --name my-api
          90â†’dipeo integrations claude-code --sync-mode auto --watch-todos
          91â†’```
          92â†’
          93â†’## Code Generation
          94â†’
          95â†’**âš ï¸ WARNING**: Code generation overwrites ALL generated code in `dipeo/diagram_generated/`!
          96â†’
          97â†’### Workflow & Staging
          98â†’1. **Modify TypeScript specs** in `/dipeo/models/src/`, then: `cd dipeo/models && pnpm build`
          99â†’2. **Generate**: `make codegen` (includes parse-typescript automatically)
         100â†’   - Outputs to `dipeo/diagram_generated_staged/` for review
         101â†’3. **Verify**: `make diff-staged` to review changes
         102â†’4. **Apply** staged â†’ active (`dipeo/diagram_generated/`), choose validation level:
         103â†’   - `make apply-syntax-only` - Syntax validation only (fastest)
         104â†’   - `make apply` - Full type checking (recommended)
         105â†’   - `make apply-test` - Server startup test (safest, includes health checks)
         106â†’5. **Update GraphQL**: `make graphql-schema`
         107â†’
         108â†’**Quick command**: `make codegen-auto` (runs all steps - USE WITH CAUTION)
         109â†’
         110â†’**Full docs**: [Code Generation Guide](docs/projects/code-generation-guide.md)
         111â†’
         112â†’## GraphQL Operations System
         113â†’
         114â†’### Architecture Overview (3-Tier System)
    max_iteration: 1
- label: Claude Response 48
  type: person_job
  position: {x: 300, y: 700}
  props:
    person: claude_code
    default_prompt: 'Process and respond: '
    max_iteration: 1
connections:
- from: Start
  to: User Input 1
  content_type: raw_text
- from: User Input 1
  to: User Input 2
  content_type: raw_text
- from: User Input 2
  to: Glob Search 3
  content_type: raw_text
- from: Glob Search 3
  to: Read File 4
  content_type: raw_text
- from: Read File 4
  to: Read File 5
  content_type: raw_text
- from: Read File 5
  to: Read File 6
  content_type: raw_text
- from: Read File 6
  to: Read File 7
  content_type: raw_text
- from: Read File 7
  to: Read File 8
  content_type: raw_text
- from: Read File 8
  to: Read File 9
  content_type: raw_text
- from: Read File 9
  to: Read File 10
  content_type: raw_text
- from: Read File 10
  to: Read File 11
  content_type: raw_text
- from: Read File 11
  to: User Input 12
  content_type: raw_text
- from: User Input 12
  to: User Input 13
  content_type: raw_text
- from: User Input 13
  to: User Input 14
  content_type: raw_text
- from: User Input 14
  to: User Input 15
  content_type: raw_text
- from: User Input 15
  to: User Input 16
  content_type: raw_text
- from: User Input 16
  to: User Input 17
  content_type: raw_text
- from: User Input 17
  to: User Input 18
  content_type: raw_text
- from: User Input 18
  to: ExitPlanMode 19
  content_type: raw_text
- from: ExitPlanMode 19
  to: Update TODO 20
  content_type: raw_text
- from: Update TODO 20
  to: Update TODO 21
  content_type: raw_text
- from: Update TODO 21
  to: MultiEdit File 22
  content_type: raw_text
- from: MultiEdit File 22
  to: Update TODO 23
  content_type: raw_text
- from: Update TODO 23
  to: MultiEdit File 24
  content_type: raw_text
- from: MultiEdit File 24
  to: Update TODO 25
  content_type: raw_text
- from: Update TODO 25
  to: MultiEdit File 26
  content_type: raw_text
- from: MultiEdit File 26
  to: Update TODO 27
  content_type: raw_text
- from: Update TODO 27
  to: Update TODO 28
  content_type: raw_text
- from: Update TODO 28
  to: User Input 29
  content_type: raw_text
- from: User Input 29
  to: Claude Response 30
  content_type: raw_text
- from: Claude Response 30
  to: Bash Command 31
  content_type: raw_text
- from: Bash Command 31
  to: Bash Command 32
  content_type: raw_text
- from: Bash Command 32
  to: Bash Command 33
  content_type: raw_text
- from: Bash Command 33
  to: Bash Command 34
  content_type: raw_text
- from: Bash Command 34
  to: Grep Search 35
  content_type: raw_text
- from: Grep Search 35
  to: Update TODO 36
  content_type: raw_text
- from: Update TODO 36
  to: Edit File 37
  content_type: raw_text
- from: Edit File 37
  to: Read File 38
  content_type: raw_text
- from: Read File 38
  to: Read File 39
  content_type: raw_text
- from: Read File 39
  to: Edit File 40
  content_type: raw_text
- from: Edit File 40
  to: Update TODO 41
  content_type: raw_text
- from: Update TODO 41
  to: Update TODO 42
  content_type: raw_text
- from: Update TODO 42
  to: User Input 43
  content_type: raw_text
- from: User Input 43
  to: Claude Response 44
  content_type: raw_text
- from: Claude Response 44
  to: Read File 45
  content_type: raw_text
- from: Read File 45
  to: Edit File 46
  content_type: raw_text
- from: Edit File 46
  to: User Input 47
  content_type: raw_text
- from: User Input 47
  to: Claude Response 48
  content_type: raw_text
persons:
  user:
    service: openai
    model: user
    api_key_id: USER_INPUT
  claude_code:
    service: anthropic
    model: claude-code
    api_key_id: APIKEY_CLAUDE
    system_prompt: |-
      You are Claude Code, an AI assistant helping with software development.

      Additional context:
      Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to.
