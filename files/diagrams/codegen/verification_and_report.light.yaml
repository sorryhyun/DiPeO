version: light
nodes:
  - label: Start
    type: start
    position: {x: 100, y: 200}
    props:
      trigger_mode: manual
      custom_data:
        registry_report: {}  # Report from registry update
        render_results: []   # All rendering results
        spec_data: {}       # Original spec data
        
  - label: Run Automated Checks
    type: code_job
    position: {x: 300, y: 200}
    props:
      functionName: run_automated_verification
      code_type: python
      code: files/codegen/code/phase2/verification_report_helpers.py
            
  - label: Evaluate Check Results
    type: condition
    position: {x: 500, y: 200}
    props:
      condition_type: custom
      expression: inputs.automated_checks.critical_issues > 0 || inputs.automated_checks.total_issues > 3
      
  - label: Generate Success Report
    type: code_job
    position: {x: 700, y: 100}
    props:
      functionName: generate_success_report
      code_type: python
      code: files/codegen/code/phase2/verification_report_helpers.py
            
  - label: Request Human Review
    type: person_job
    position: {x: 700, y: 300}
    props:
      person: CodeReviewer
      first_only_prompt: |
        Code generation completed with issues requiring review:
        
        Node Type: {{spec_data.nodeType}}
        Total Issues: {{automated_checks.total_issues}}
        Critical Issues: {{automated_checks.critical_issues}}
        
        Issues Found:
        {{#each automated_checks.syntax_checks}}
        {{#if (eq status "fail")}}
        - {{file}}: {{message}}
        {{/if}}
        {{/each}}
        
        {{#each automated_checks.type_checks}}
        {{#if (eq status "fail")}}
        - {{file}}: {{message}}
        {{/if}}
        {{/each}}
        
        Generated Files:
        {{#each registry_report.files_generated}}
        - {{this}}
        {{/each}}
        
        Please review the issues and provide:
        1. Assessment of severity (can these be auto-fixed?)
        2. Specific fixes needed
        3. Whether to proceed despite issues
        4. Any security concerns
        
        Provide a PROCEED/RETRY/ABORT recommendation.
      max_iteration: 1
      
  - label: Process Review Decision
    type: code_job
    position: {x: 900, y: 300}
    props:
      functionName: process_review_decision
      code_type: python
      code: files/codegen/code/phase2/verification_report_helpers.py
            
  - label: Format Final Report
    type: template_job
    position: {x: 1100, y: 200}
    props:
      template_path: files/templates/codegen/phase2/verification_report.hbs
      engine: handlebars
      
  - label: End
    type: endpoint
    position: {x: 1300, y: 200}
    props:
      save_to_file: true
      file_name: logs/codegen/verification_report_{{spec_data.nodeType}}_{{timestamp}}.md

connections:
  - from: Start
    to: Run Automated Checks
    content_type: object
    
  - from: Run Automated Checks
    to: Evaluate Check Results
    content_type: object
    
  - from: Evaluate Check Results
    to: Generate Success Report
    label: condfalse
    content_type: object
    
  - from: Evaluate Check Results
    to: Request Human Review
    label: condtrue
    content_type: object
    
  - from: Start
    to: Generate Success Report
    content_type: object
    
  - from: Start
    to: Request Human Review
    content_type: object
    
  - from: Request Human Review
    to: Process Review Decision
    content_type: raw_text
    label: review_response
    
  - from: Start
    to: Process Review Decision
    content_type: object
    
  - from: Generate Success Report
    to: Format Final Report
    content_type: object
    
  - from: Process Review Decision
    to: Format Final Report
    content_type: object
    
  - from: Format Final Report
    to: End
    content_type: raw_text

persons:
  CodeReviewer:
    service: openai
    model: gpt-4.1-nano
    api_key_id: APIKEY_52609F