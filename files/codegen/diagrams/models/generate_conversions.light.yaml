# Generate Domain Model Conversions from TypeScript
# Replaces dipeo/models/scripts/generate-conversions.ts
# Generates conversion utilities between TypeScript and Python types

version: light

nodes:
  - label: Start
    type: start
    position: {x: 50, y: 200}
    props:
      custom_data:
        message: Starting domain model conversions generation

  # Load conversions.ts file
  - label: Load Conversions TS
    type: db
    position: {x: 200, y: 200}
    props:
      operation: read
      sub_type: file
      source_details: dipeo/models/src/conversions.ts

  # Parse TypeScript to extract NODE_TYPE_MAP
  - label: Parse Conversions AST
    type: typescript_ast
    position: {x: 400, y: 200}
    props:
      extractPatterns: ["const"]
      includeJSDoc: false
      parseMode: module

  # Extract NODE_TYPE_MAP entries
  - label: Extract NODE_TYPE_MAP
    type: code_job
    position: {x: 600, y: 200}
    props:
      language: python
      filePath: files/codegen/code/models/extractors/node_type_map_extractor.py
      functionName: main

  # Load conversions template
  - label: Load Conversions Template
    type: db
    position: {x: 600, y: 350}
    props:
      operation: read
      sub_type: file
      source_details: files/codegen/templates/models/conversions.j2

  # Generate conversions code
  - label: Generate Conversions Code
    type: code_job
    position: {x: 800, y: 275}
    props:
      language: python
      filePath: files/codegen/code/models/generators/conversions_generator.py
      functionName: main

  # Write conversions.py
  - label: Write Conversions File
    type: db
    position: {x: 1200, y: 275}
    props:
      operation: write
      sub_type: file
      source_details: dipeo/diagram_generated/conversions.py

  # Generate success summary
  - label: Generate Summary
    type: code_job
    position: {x: 1400, y: 275}
    props:
      language: python
      filePath: files/codegen/code/models/generators/summary_generator.py
      functionName: main

  - label: End
    type: endpoint
    position: {x: 1600, y: 275}
    props:
      save_to_file: false

connections:
  # Load and parse TypeScript
  - from: Start
    to: Load Conversions TS
  - from: Start
    to: Load Conversions Template
  - from: Load Conversions TS
    to: Parse Conversions AST
    label: source
  
  # Extract mappings
  - from: Parse Conversions AST
    to: Extract NODE_TYPE_MAP
  - from: Load Conversions TS
    to: Extract NODE_TYPE_MAP
    label: source
  
  # Send data to code generator
  - from: Extract NODE_TYPE_MAP
    to: Generate Conversions Code
    label: data
  
  # Send template to code generator
  - from: Load Conversions Template
    to: Generate Conversions Code
    label: template_content
  
  # Write output
  - from: Generate Conversions Code
    to: Write Conversions File
    label: generated_code
  
  # Generate summary
  - from: Extract NODE_TYPE_MAP
    to: Generate Summary
    label: node_type_map
  - from: Write Conversions File
    to: End
  - from: Generate Summary
    to: End