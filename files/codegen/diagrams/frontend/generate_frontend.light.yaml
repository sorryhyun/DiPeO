# Frontend Batch Generation with TypeScript Specifications V2
# Uses the v2 diagrams with template_job nodes for simplified generation

version: light

nodes:
  - label: Start
    type: start
    position: {x: 50, y: 200}
    props:
      custom_data:
        message: Starting batch generation using v2 template job approach

  # Run batch parser for all TypeScript files
  - label: Parse All TypeScript
    type: sub_diagram
    position: {x: 200, y: 200}
    props:
      diagram_name: codegen/diagrams/shared/parse_typescript_batch
      diagram_format: light
      passInputData: false
      ignoreIfSub: true

  # NEW: Discover node spec files dynamically using glob patterns
  - label: Discover Node Specs
    type: db
    position: {x: 350, y: 200}
    props:
      operation: read
      sub_type: file
      serialize_json: true  # Parse JSON files automatically
      glob: true  # Enable glob pattern expansion
      source_details:
        # Dynamically discover all node spec files
        - "temp/specifications/nodes/*.spec.ts.json"

  - label: Prepare Node List
    type: code_job
    position: {x: 500, y: 200}
    props:
      language: python
      filePath: files/codegen/code/frontend/prepare_node_list_from_specs.py
      functionName: prepare_node_list_from_specs

  # Use the simplified diagram with template_job nodes
  - label: Batch Generate Frontend
    type: sub_diagram
    position: {x: 700, y: 200}
    props:
      diagram_name: codegen/diagrams/frontend/generate_frontend_single
      diagram_format: light
      batch: true  # Enable batch mode
      batch_input_key: items  # Use 'items' key from input
      batch_parallel: true  # Process in parallel

  - label: Process Results
    type: code_job
    position: {x: 900, y: 200}
    props:
      language: python
      code: |
        # Process batch results
        batch_results = inputs.get('default', {})
        
        total = batch_results.get('total_items', 0)
        successful = batch_results.get('successful', 0)
        failed = batch_results.get('failed', 0)
        
        print(f"\n=== TypeScript Batch Generation Summary ===")
        print(f"Total items: {total}")
        print(f"Successful: {successful}")
        print(f"Failed: {failed}")
        
        if batch_results.get('errors'):
            print("\nErrors:")
            for error in batch_results['errors']:
                print(f"  - Item {error['index']}: {error['error']}")
        
        # Extract generated file counts
        results = batch_results.get('results', [])
        total_files = 0
        for r in results:
            if isinstance(r, dict) and 'files_generated' in r:
                total_files += r['files_generated']
        
        result = {
            'message': f'TypeScript batch generation completed: {successful}/{total} successful',
            'total_files_generated': total_files,
            'status': 'success' if failed == 0 else 'partial_failure'
        }

  - label: Generate Registry
    type: sub_diagram
    position: {x: 1100, y: 200}
    props:
      diagram_name: codegen/diagrams/frontend/generate_frontend_registry
      diagram_format: light
      passInputData: false

  # Use v2 diagrams for these
  - label: Generate GraphQL Queries
    type: sub_diagram
    position: {x: 1300, y: 200}
    props:
      diagram_name: codegen/diagrams/frontend/generate_graphql_queries
      diagram_format: light
      passInputData: false

  - label: Generate Zod Schemas
    type: sub_diagram
    position: {x: 1300, y: 300}
    props:
      diagram_name: codegen/diagrams/frontend/generate_zod_schemas_v2
      diagram_format: light
      passInputData: false

  - label: Generate Field Configs
    type: sub_diagram
    position: {x: 1300, y: 400}
    props:
      diagram_name: codegen/diagrams/frontend/generate_field_configs_v2
      diagram_format: light
      passInputData: false

  - label: End
    type: endpoint
    position: {x: 1500, y: 200}
    props:
      save_to_file: false

connections:
  - from: Start
    to: Parse All TypeScript
  
  - from: Parse All TypeScript
    to: Discover Node Specs
  
  - from: Discover Node Specs
    to: Prepare Node List
  
  - from: Prepare Node List
    to: Batch Generate Frontend
  
  - from: Batch Generate Frontend
    to: Process Results
  
  - from: Process Results
    to: Generate Registry
  
  - from: Generate Registry
    to: Generate GraphQL Queries
  
  - from: Generate Registry
    to: Generate Zod Schemas
  
  - from: Generate Registry
    to: Generate Field Configs
  
  - from: Generate GraphQL Queries
    to: End
  
  - from: Generate Zod Schemas
    to: End
  
  - from: Generate Field Configs
    to: End