# Simplified TypeScript Parser (Single File)
# Takes a file path, parses it, saves cache, and returns AST data

version: light

nodes:
  - label: Start
    type: start
    position: {x: 50, y: 200}
    
  # Extract file info for cache path
  - label: Extract File Info
    type: code_job
    position: {x: 200, y: 200}
    props:
      language: python
      code: |
        import os
        
        # Get file path from input
        input_data = inputs.get('default', {})
        
        if isinstance(input_data, str):
            file_path = input_data
        elif isinstance(input_data, dict):
            file_path = input_data.get('file_path', '')
        else:
            file_path = ''
        
        # Preserve directory structure in cache path
        base_dir = os.environ.get('DIPEO_BASE_DIR', '/home/soryhyun/DiPeO')
        models_dir = os.path.join(base_dir, 'dipeo/models/src')
        
        # Get relative path from models_dir
        if file_path.startswith(models_dir):
            relative_path = os.path.relpath(file_path, models_dir)
        else:
            # Fallback to basename if not in expected location
            relative_path = os.path.basename(file_path)
        
        # Create cache path preserving directory structure
        cache_path = f'temp/{relative_path}.json'
        cache_dir = os.path.dirname(cache_path)
        
        # Ensure cache directory exists
        if cache_dir and cache_dir != 'temp':
            os.makedirs(cache_dir, exist_ok=True)
        
        result = {
            'file_path': file_path,
            'cache_path': cache_path
        }
    
  # Load the TypeScript source file
  - label: Load TS Source
    type: db
    position: {x: 400, y: 200}
    props:
      operation: read
      sub_type: file
      source_details: "{info.file_path}"
  
  # Parse TypeScript AST
  - label: Parse TypeScript AST
    type: typescript_ast
    position: {x: 600, y: 200}
    props:
      includeJSDoc: true
      parseMode: module
      outputFormat: for_codegen
      extractPatterns: ["interface", "type", "enum", "const"]
      
  # Save to cache
  - label: Save Cache
    type: db
    position: {x: 800, y: 200}
    props:
      operation: write
      sub_type: file
      source_details: "{info.cache_path}"
      data: "{ast}"
      serialize_json: true
      
  # End with parsed data
  - label: End
    type: endpoint
    position: {x: 1000, y: 200}
    props:
      save_to_file: false
      
connections:
  - from: Start
    to: Extract File Info
    
  - from: Extract File Info
    to: Load TS Source
    label: info
    
  - from: Load TS Source
    to: Parse TypeScript AST
    label: source
    
  - from: Parse TypeScript AST
    to: Save Cache
    label: ast
    
  - from: Extract File Info
    to: Save Cache
    label: info
    
  - from: Save Cache
    to: End