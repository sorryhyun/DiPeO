# Backend Single Node Generation from TypeScript
# Generates Pydantic model, GraphQL schema, and static node from TypeScript specifications

version: light

nodes:
  # Start node
  - label: Start
    type: start
    position: {x: 50, y: 100}

  # Parse input to handle both direct variables and nested inputs
  - label: Parse Input
    type: code_job
    position: {x: 50, y: 150}
    props:
      language: python
      code: |
        # Handle both direct input (from CLI) and nested input (from sub_diagram)
        if "node_spec_path" in default:
            # Direct case - pass through
            result = {"node_spec_path": default["node_spec_path"]}
        elif "default" in default and isinstance(default["default"], dict) and "node_spec_path" in default["default"]:
            # Nested case from sub_diagram
            result = {"node_spec_path": default["default"]["node_spec_path"]}
        else:
            raise ValueError(f"node_spec_path not found in input: {default}")
      
  # Convert node_spec_path to filename
  - label: Prepare Filename
    type: code_job
    position: {x: 200, y: 200}
    props:
      language: python
      code: |
        # Convert underscore to hyphen for filename
        # node_spec_path comes as a dict from Parse Input
        if isinstance(node_spec_path, dict):
            node_type = node_spec_path.get('node_spec_path', 'unknown')
        else:
            node_type = node_spec_path
            
        node_type_filename = node_type.replace('_', '-')
        result = {
            'node_type': node_type,
            'node_type_filename': node_type_filename
        }
  
  # Load TypeScript specification file
  - label: Load TypeScript Spec
    type: db
    position: {x: 350, y: 200}
    props:
      operation: read
      sub_type: file
      source_details: dipeo/models/src/node-specs/{data.node_type_filename}.spec.ts
      
  # Parse TypeScript to extract the specification
  - label: Parse TypeScript AST
    type: typescript_ast
    position: {x: 500, y: 200}
    props:
      extractPatterns: ["const", "export"]
      includeJSDoc: true
      parseMode: module
      
  # Extract specification from AST
  - label: Extract Specification
    type: code_job
    position: {x: 700, y: 200}
    props:
      language: python
      code: |
        # Import the parser helper
        from files.codegen.code.shared.typescript_spec_parser import extract_spec_from_ast, transform_ast_to_spec
        
        # The ast_data comes from typescript_ast node
        
        # Extract the actual node type string if it comes as a dict
        if isinstance(node_type, dict):
            actual_node_type = node_type.get('node_type', 'unknown')
        else:
            actual_node_type = node_type
        
        # Convert node type to spec name (e.g., "person_job" -> "personJobSpec")
        node_type_clean = actual_node_type.replace('-', '_')  # Normalize to underscores
        spec_name = f"{node_type_clean.replace('_', ' ').title().replace(' ', '')}Spec"
        spec_name = spec_name[0].lower() + spec_name[1:]  # camelCase
        
        # Extract the specification from AST
        spec_data = extract_spec_from_ast(ast_data, spec_name)
        
        if not spec_data:
            available_constants = [const.get('name', '') for const in ast_data.get('constants', [])]
            raise ValueError(
                f"Could not find specification '{spec_name}' for node type '{actual_node_type}'. "
                f"Available constants: {available_constants}"
            )
        
        result = spec_data
  
  # Load backend templates
  - label: Load Pydantic Template
    type: db
    position: {x: 100, y: 300}
    props:
      operation: read
      sub_type: file  
      source_details: files/codegen/templates/backend/pydantic_single_model.j2

  - label: Load GraphQL Template
    type: db
    position: {x: 100, y: 400}
    props:
      operation: read
      sub_type: file
      source_details: files/codegen/templates/backend/graphql_schema.j2

  - label: Load Static Node Template
    type: db
    position: {x: 100, y: 500}
    props:
      operation: read
      sub_type: file
      source_details: files/codegen/templates/backend/static_nodes.j2

  # Generate backend code
  - label: Generate Pydantic Model
    type: code_job
    position: {x: 600, y: 300}
    props:
      language: python
      filePath: files/codegen/code/backend/generators/pydantic_model.py
      functionName: main

  - label: Generate GraphQL Schema
    type: code_job
    position: {x: 600, y: 400}
    props:
      language: python
      filePath: files/codegen/code/backend/generators/graphql_schema.py
      functionName: main

  - label: Generate Static Node
    type: code_job
    position: {x: 600, y: 500}
    props:
      language: python
      filePath: files/codegen/code/backend/generators/static_nodes.py
      functionName: main

  # Extract node type from spec for file paths
  - label: Extract Node Type
    type: code_job
    position: {x: 400, y: 100}
    props:
      language: python
      code: |
        # Extract node type from spec for use in file paths
        spec = spec_data
        
        # Ensure spec is a dict
        if isinstance(spec, str):
            import json
            spec = json.loads(spec)
        elif not isinstance(spec, dict):
            raise ValueError(f"Expected dict or string, got {type(spec)}")
            
        node_type = spec.get('nodeType', 'unknown')
        node_name = node_type.title().replace('_', '')
        result = {
            'node_type': node_type,
            'node_name': node_name
        }

  # Write backend outputs
  - label: Write Pydantic Model
    type: db
    position: {x: 900, y: 300}
    props:
      operation: write
      sub_type: file
      source_details: dipeo/diagram_generated_staged/models/{node_naming.node_type}_model.py

  - label: Write GraphQL Schema
    type: db
    position: {x: 900, y: 400}
    props:
      operation: write
      sub_type: file
      source_details: apps/server/src/__generated__/{node_naming.node_type}.graphql

  - label: Write Static Node
    type: db
    position: {x: 900, y: 500}
    props:
      operation: write
      sub_type: file
      source_details: dipeo/diagram_generated_staged/nodes/{node_naming.node_type}_node.py

connections:
  # Parse input first
  - from: Start
    to: Parse Input
    
  # Prepare filename for TypeScript spec
  - from: Parse Input
    to: Prepare Filename
    label: node_spec_path
    
  # Load the TypeScript spec file
  - from: Prepare Filename
    to: Load TypeScript Spec
    label: data
    
  # Parse TypeScript AST
  - from: Load TypeScript Spec
    to: Parse TypeScript AST
    label: source
    
  # Extract specification from AST
  - from: Parse TypeScript AST
    to: Extract Specification
    label: ast_data
    
  # Pass node_type to Extract Specification
  - from: Prepare Filename
    to: Extract Specification
    label: node_type
    
  # Pass spec to extract node type
  - from: Extract Specification
    to: Extract Node Type
    label: spec_data
    
  # Pass node naming to all writers (for file paths)
  - from: Extract Node Type
    to: Write Pydantic Model
    label: node_naming
  - from: Extract Node Type
    to: Write GraphQL Schema
    label: node_naming
  - from: Extract Node Type
    to: Write Static Node
    label: node_naming

  # Connect spec and templates to Pydantic generator
  - from: Extract Specification
    to: Generate Pydantic Model
    label: spec_data
  - from: Load Pydantic Template
    to: Generate Pydantic Model
    label: template_content
  
  # Connect spec and templates to GraphQL generator
  - from: Extract Specification
    to: Generate GraphQL Schema
    label: spec_data
  - from: Load GraphQL Template
    to: Generate GraphQL Schema
    label: template_content

  # Connect spec and templates to Static Node generator
  - from: Extract Specification
    to: Generate Static Node
    label: spec_data
  - from: Load Static Node Template
    to: Generate Static Node
    label: template_content
  
  # Connect generators to writers (passing generated code)
  - from: Generate Pydantic Model
    to: Write Pydantic Model
    label: generated_code
  - from: Generate GraphQL Schema
    to: Write GraphQL Schema
    label: generated_code
  - from: Generate Static Node
    to: Write Static Node
    label: generated_code